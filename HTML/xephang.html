<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Báº£ng Xáº¿p Háº¡ng</title>
  <link rel="stylesheet" href="/CSS/xephang.css">
</head>
<body>
  <div class="header">
    <div class="logo">ğŸ® VALORANT</div>
    <div class="nav">
      <a href="index.html">Trang chá»§</a>
      <a href="giaidau.html">Giáº£i Ä‘áº¥u</a>
      <a href="team.html">Team</a>
      <a href="trandau.html">Tráº­n Äáº¥u</a>
      <a href="xephang.html" class="active">Báº£ng Xáº¿p Háº¡ng</a>
      <a href="map.html">Map</a>
      <a href="admin.html" id="adminLink" style="display: none;">Quáº£n LÃ½</a>
    </div>
    <div class="auth-buttons" id="authButtons">
      <a href="login.html" class="login-btn" id="loginBtn">ÄÄƒng nháº­p</a>
      <a href="register.html" class="register-btn" id="registerBtn">ÄÄƒng kÃ½</a>
    </div>
  </div>

  <div class="container">
    <h1 class="page-title">ğŸ† Báº£ng Xáº¿p Háº¡ng</h1>
    <p class="page-subtitle">Theo dÃµi thá»© háº¡ng cá»§a cÃ¡c Ä‘á»™i tuyá»ƒn trong tá»«ng giáº£i Ä‘áº¥u</p>

    <div class="filters">
      <div class="filter-group">
        <label for="giaiSelect">Chá»n Giáº£i Äáº¥u:</label>
        <select id="giaiSelect">
          <option value="">Táº¥t cáº£ giáº£i Ä‘áº¥u</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="sortSelect">Sáº¯p xáº¿p theo:</label>
        <select id="sortSelect">
          <option value="points">Äiá»ƒm sá»‘</option>
          <option value="matches">Sá»‘ tráº­n Ä‘Ã£ chÆ¡i</option>
          <option value="wins">Sá»‘ tráº­n tháº¯ng</option>
          <option value="winrate">Tá»· lá»‡ tháº¯ng</option>
        </select>
      </div>
    </div>

    <div id="loadingMessage" class="loading">
      ğŸ”„ Äang táº£i dá»¯ liá»‡u...
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <div id="rankingContainer"></div>

    <div id="noDataMessage" class="no-data" style="display: none;">
      ğŸ“Š ChÆ°a cÃ³ dá»¯ liá»‡u báº£ng xáº¿p háº¡ng
    </div>
  </div>

  <script>
    let allRankingData = [];
    let tournaments = [];

    // API Base URL
    const API_BASE_URL = 'http://localhost:5000'; // Thay Ä‘á»•i theo URL API cá»§a báº¡n

    // Khá»Ÿi táº¡o trang
    document.addEventListener('DOMContentLoaded', function() {
      loadTournaments();
      loadRankingData();
      
      // Event listeners
      document.getElementById('giaiSelect').addEventListener('change', filterRankings);
      document.getElementById('sortSelect').addEventListener('change', filterRankings);
    });

    // Táº£i danh sÃ¡ch giáº£i Ä‘áº¥u
    async function loadTournaments() {
      try {
        const response = await fetch(`${API_BASE_URL}/GiaiDau/GetAll`);
        if (response.ok) {
          tournaments = await response.json();
          populateTournamentSelect();
        }
      } catch (error) {
        console.error('Lá»—i khi táº£i danh sÃ¡ch giáº£i Ä‘áº¥u:', error);
      }
    }

    // Äiá»n danh sÃ¡ch giáº£i Ä‘áº¥u vÃ o select
    function populateTournamentSelect() {
      const select = document.getElementById('giaiSelect');
      select.innerHTML = '<option value="">Táº¥t cáº£ giáº£i Ä‘áº¥u</option>';
      
      tournaments.forEach(tournament => {
        const option = document.createElement('option');
        option.value = tournament.IdGiai;
        option.textContent = tournament.TenGiai;
        select.appendChild(option);
      });
    }

    // Táº£i dá»¯ liá»‡u báº£ng xáº¿p háº¡ng
    async function loadRankingData() {
      try {
        showLoading(true);
        const response = await fetch(`${API_BASE_URL}/BangXepHang/GetAll`);
        
        if (response.ok) {
          allRankingData = await response.json();
          filterRankings();
        } else {
          throw new Error('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u');
        }
      } catch (error) {
        showError('Lá»—i khi táº£i dá»¯ liá»‡u báº£ng xáº¿p háº¡ng: ' + error.message);
      } finally {
        showLoading(false);
      }
    }

    // Lá»c vÃ  hiá»ƒn thá»‹ báº£ng xáº¿p háº¡ng
    function filterRankings() {
      const selectedTournament = document.getElementById('giaiSelect').value;
      const sortBy = document.getElementById('sortSelect').value;

      let filteredData = allRankingData;

      // Lá»c theo giáº£i Ä‘áº¥u
      if (selectedTournament) {
        filteredData = filteredData.filter(item => item.IdGiai == selectedTournament);
      }

      // Sáº¯p xáº¿p dá»¯ liá»‡u
      filteredData = sortRankingData(filteredData, sortBy);

      // NhÃ³m theo giáº£i Ä‘áº¥u
      const groupedData = groupByTournament(filteredData);
      
      displayRankings(groupedData);
    }

    // Sáº¯p xáº¿p dá»¯ liá»‡u
    function sortRankingData(data, sortBy) {
      return data.sort((a, b) => {
        switch (sortBy) {
          case 'points':
            return b.Diem - a.Diem;
          case 'matches':
            return b.TranDa - a.TranDa;
          case 'wins':
            return b.TranThang - a.TranThang;
          case 'winrate':
            const winRateA = a.TranDa > 0 ? (a.TranThang / a.TranDa) : 0;
            const winRateB = b.TranDa > 0 ? (b.TranThang / b.TranDa) : 0;
            return winRateB - winRateA;
          default:
            return b.Diem - a.Diem;
        }
      });
    }

    // NhÃ³m dá»¯ liá»‡u theo giáº£i Ä‘áº¥u
    function groupByTournament(data) {
      const grouped = {};
      data.forEach(item => {
        const tournamentName = item.TenGiai || 'ChÆ°a xÃ¡c Ä‘á»‹nh';
        if (!grouped[tournamentName]) {
          grouped[tournamentName] = [];
        }
        grouped[tournamentName].push(item);
      });
      return grouped;
    }

    // Hiá»ƒn thá»‹ báº£ng xáº¿p háº¡ng
    function displayRankings(groupedData) {
      const container = document.getElementById('rankingContainer');
      const noDataMessage = document.getElementById('noDataMessage');

      if (Object.keys(groupedData).length === 0) {
        container.innerHTML = '';
        noDataMessage.style.display = 'block';
        return;
      }

      noDataMessage.style.display = 'none';
      let html = '';

      Object.entries(groupedData).forEach(([tournamentName, rankings]) => {
        html += createTournamentTable(tournamentName, rankings);
      });

      container.innerHTML = html;
    }

    // Táº¡o báº£ng cho tá»«ng giáº£i Ä‘áº¥u
    function createTournamentTable(tournamentName, rankings) {
      let html = `
        <div class="ranking-table">
          <div class="table-header">
            ${tournamentName}
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Háº¡ng</th>
                <th>Äá»™i</th>
                <th>Tráº­n</th>
                <th>Tháº¯ng</th>
                <th>Thua</th>
                <th>Tá»· lá»‡ Map</th>
                <th>Äiá»ƒm</th>
                <th>Tá»· lá»‡ tháº¯ng</th>
              </tr>
            </thead>
            <tbody>
      `;

      rankings.forEach((team, index) => {
        const rank = index + 1;
        const winRate = team.TranDa > 0 ? ((team.TranThang / team.TranDa) * 100).toFixed(1) : '0.0';
        const rankClass = getRankClass(rank);

        html += `
          <tr>
            <td class="rank-position ${rankClass}">${rank}</td>
            <td>
              <div class="team-info">
                <div class="team-logo">${team.TenTeam ? team.TenTeam.charAt(0).toUpperCase() : 'T'}</div>
                <div class="team-name">${team.TenTeam || 'ChÆ°a cÃ³ tÃªn'}</div>
              </div>
            </td>
            <td>${team.TranDa}</td>
            <td style="color: #4caf50; font-weight: 600;">${team.TranThang}</td>
            <td style="color: #f44336; font-weight: 600;">${team.TranThua}</td>
            <td class="map-ratio">${team.TiLe}</td>
            <td class="points">${team.Diem}</td>
            <td class="win-rate">${winRate}%</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      return html;
    }

    // Láº¥y class CSS cho thá»© háº¡ng
    function getRankClass(rank) {
      switch (rank) {
        case 1: return 'rank-1';
        case 2: return 'rank-2';
        case 3: return 'rank-3';
        default: return '';
      }
    }

    // Hiá»ƒn thá»‹ loading
    function showLoading(show) {
      const loading = document.getElementById('loadingMessage');
      loading.style.display = show ? 'block' : 'none';
    }

    // Hiá»ƒn thá»‹ lá»—i
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }
  </script>
  <script>
    function updateAdminLink() {
        const adminLink = document.getElementById('adminLink');
        if (!adminLink) {
            console.warn('Admin link element not found');
            return;
        }
    
        const user = localStorage.getItem('adminUser');
        if (user) {
            try {
                const userData = JSON.parse(user);
                if (userData.VaiTro === 'Admin') {
                    adminLink.style.display = 'block';
                } else {
                    adminLink.style.display = 'none';
                }
            } catch (error) {
                console.error('Error parsing adminUser:', error);
                adminLink.style.display = 'none';
            }
        } else {
            adminLink.style.display = 'none';
        }
    }
    
    // Gá»i khi trang táº£i
    window.addEventListener('load', updateAdminLink);
    
    // Láº¯ng nghe sá»± kiá»‡n tÃ¹y chá»‰nh 'authChanged' Ä‘á»ƒ cáº­p nháº­t khi Ä‘Äƒng nháº­p/Ä‘Äƒng xuáº¥t
    window.addEventListener('authChanged', updateAdminLink);
</script>

<script>
  // Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p khi trang Ä‘Æ°á»£c táº£i
  window.addEventListener('load', function() {
      updateAuthButtons();
  });

  function updateAuthButtons() {
      const authButtons = document.getElementById('authButtons');
      const token = localStorage.getItem('adminToken');
      const user = localStorage.getItem('adminUser');

      if (token && user) {
          // NgÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p
          const userData = JSON.parse(user);
          authButtons.innerHTML = `
              <div class="user-info" style="display: flex; align-items: center; gap: 10px;">
                  <span style="color: white; font-size: 14px;">Xin chÃ o, ${userData.HoTen || userData.TenDangNhap}</span>
                  <button onclick="logout()" class="logout-btn" style="
                      background: #ff4757;
                      color: white;
                      border: none;
                      padding: 8px 16px;
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 14px;
                      transition: background 0.3s;
                  " onmouseover="this.style.background='#ff3742'" onmouseout="this.style.background='#ff4757'">
                      ÄÄƒng xuáº¥t
                  </button>
              </div>
          `;
      } else {
          // NgÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p
          authButtons.innerHTML = `
              <a href="login.html" class="login-btn">ÄÄƒng nháº­p</a>
              <a href="register.html" class="register-btn">ÄÄƒng kÃ½</a>
          `;
      }

      // KÃ­ch hoáº¡t sá»± kiá»‡n authChanged Ä‘á»ƒ cáº­p nháº­t liÃªn káº¿t Quáº£n LÃ½
      window.dispatchEvent(new Event('authChanged'));
  }

  function logout() {
      // Hiá»ƒn thá»‹ xÃ¡c nháº­n trÆ°á»›c khi Ä‘Äƒng xuáº¥t
      if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n Ä‘Äƒng xuáº¥t khÃ´ng?')) {
          // XÃ³a thÃ´ng tin Ä‘Äƒng nháº­p khá»i localStorage
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          
          // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o
          alert('ÄÃ£ Ä‘Äƒng xuáº¥t thÃ nh cÃ´ng!');
          
          // Cáº­p nháº­t láº¡i giao diá»‡n
          updateAuthButtons();
      }
  }

  // Kiá»ƒm tra token cÃ³ háº¿t háº¡n khÃ´ng (tÃ¹y chá»n)
  function checkTokenExpiry() {
      const token = localStorage.getItem('adminToken');
      if (token) {
          try {
              // Decode JWT token Ä‘á»ƒ kiá»ƒm tra thá»i gian háº¿t háº¡n
              const payload = JSON.parse(atob(token.split('.')[1]));
              const currentTime = Date.now() / 1000;
              
              if (payload.exp < currentTime) {
                  // Token Ä‘Ã£ háº¿t háº¡n
                  localStorage.removeItem('adminToken');
                  localStorage.removeItem('adminUser');
                  updateAuthButtons();
                  alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i!');
              }
          } catch (error) {
              console.error('Error checking token expiry:', error);
          }
      }
  }

  // Kiá»ƒm tra token má»—i 5 phÃºt
  setInterval(checkTokenExpiry, 5 * 60 * 1000);
  
  // Kiá»ƒm tra token ngay khi trang Ä‘Æ°á»£c táº£i
  checkTokenExpiry();
</script>
</body>
</html>