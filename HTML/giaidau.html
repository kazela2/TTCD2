<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·∫£i ƒê·∫•u</title>
    <link rel="stylesheet" href="/CSS/giaidau.css">
</head>
<body>
    <div class="header">
        <div class="logo">üéÆ</div>
        <div class="nav">
            <a href="index.html">Trang ch·ªß</a>
            <a href="giaidau.html">Gi·∫£i ƒë·∫•u</a>
            <a href="team.html">ƒê·ªôi thi ƒë·∫•u</a>
            <a href="trandau.html">Tr·∫≠n ƒê·∫•u</a>
            <a href="xephang.html">B·∫£ng X·∫øp H·∫°ng</a>
            <a href="admin.html">Qu·∫£n L√Ω</a>
        </div>
        <div class="auth-buttons" id="authButtons">
            <a href="login.html" class="login-btn" id="loginBtn">ƒêƒÉng nh·∫≠p</a>
            <a href="register.html" class="register-btn" id="registerBtn">ƒêƒÉng k√Ω</a>
        </div>
    </div>

    <div class="search-container">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm Gi·∫£i ƒê·∫•u..." />
        </div>
    </div>

    <div id="giaidauContainer" class="card-container">
        <!-- Cards will be generated by JavaScript -->
    </div>

    <!-- Modal for video -->
    <div id="videoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Video Gi·∫£i ƒê·∫•u</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="video-container">
                    <iframe id="youtubeVideo" src="" frameborder="0" allowfullscreen></iframe>
                </div>
                <div id="modalDescription"></div>
            </div>
        </div>
    </div>

    <script>
        // Sample YouTube video IDs for demonstration
        const youtubeVideos = [
            'np9B7nYaQt8', // Rick Roll
            '9eppqLb5OU0', // Luis Fonsi - Despacito
            '2miTU6k3z7g', // PSY - GANGNAM STYLE
            '0ZB1ec5yJK8', // Queen - Bohemian Rhapsody
            'i4bDPnZNkNs', // Smash Mouth - All Star
            'K4ghlwcNeMw', // Adele - Hello
            'LLkFAp9S0FY', // Katy Perry - Roar
            'Vy4nPexeOgA', // Counting Stars
        ];

        function getRandomVideo() {
            return youtubeVideos[Math.floor(Math.random() * youtubeVideos.length)];
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return 'Ch∆∞a x√°c ƒë·ªãnh';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        async function loadGiaiDau() {
            try {
                const res = await fetch('http://127.0.0.1:5000/GiaiDau/GetAll');
                const data = await res.json();

                const container = document.getElementById('giaidauContainer');
                container.innerHTML = '';

                if (data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: white; font-size: 1.2rem;">Kh√¥ng c√≥ gi·∫£i ƒë·∫•u n√†o ƒë∆∞·ª£c t√¨m th·∫•y.</p>';
                    return;
                }

                data.forEach(item => {
                    const card = document.createElement('div');
                    card.classList.add('card');
                    card.setAttribute('data-ten', item.TenGiai.toLowerCase());
                    card.setAttribute('data-id', item.IdGiai);

                    card.innerHTML = `
                        <div class="card-header">
                            <h3>${item.TenGiai}</h3>
                            ${item.GiaiThuong > 0 ? `<div class="prize-badge">${formatCurrency(item.GiaiThuong)}</div>` : ''}
                        </div>
                        
                        <div class="card-info">
                            <div class="info-item">
                                <span class="info-label">üìÖ Ng√†y b·∫Øt ƒë·∫ßu</span>
                                <span class="info-value">${formatDate(item.NgayBatDau)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">üèÅ Ng√†y k·∫øt th√∫c</span>
                                <span class="info-value">${formatDate(item.NgayKetThuc)}</span>
                            </div>
                        </div>

                        ${item.MoTa ? `<div class="card-description">${item.MoTa}</div>` : ''}
                        
                        <div style="text-align: center;">
                            <span class="team-count">üë• ${item.SoTeamThamGia} ƒë·ªôi tham gia</span>
                        </div>
                        
                        <div class="play-icon"></div>
                    `;

                    card.addEventListener('click', () => openModal(item));
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('L·ªói khi l·∫•y d·ªØ li·ªáu:', error);
                const container = document.getElementById('giaidauContainer');
                container.innerHTML = '<p style="text-align: center; color: white; font-size: 1.2rem;">‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu gi·∫£i ƒë·∫•u.</p>';
            }
        }

        function openModal(tournament) {
            const modal = document.getElementById('videoModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalDescription = document.getElementById('modalDescription');
            const youtubeVideo = document.getElementById('youtubeVideo');

            modalTitle.textContent = tournament.TenGiai;
            modalDescription.innerHTML = `
                <h3>Th√¥ng tin chi ti·∫øt</h3>
                <p><strong>Ng√†y b·∫Øt ƒë·∫ßu:</strong> ${formatDate(tournament.NgayBatDau)}</p>
                <p><strong>Ng√†y k·∫øt th√∫c:</strong> ${formatDate(tournament.NgayKetThuc)}</p>
                <p><strong>S·ªë ƒë·ªôi tham gia:</strong> ${tournament.SoTeamThamGia}</p>
                ${tournament.GiaiThuong > 0 ? `<p><strong>Gi·∫£i th∆∞·ªüng:</strong> ${formatCurrency(tournament.GiaiThuong)}</p>` : ''}
                ${tournament.MoTa ? `<p><strong>M√¥ t·∫£:</strong> ${tournament.MoTa}</p>` : ''}
            `;

            const videoId = getRandomVideo();
            youtubeVideo.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('videoModal');
            const youtubeVideo = document.getElementById('youtubeVideo');
            
            modal.style.display = 'none';
            youtubeVideo.src = '';
            document.body.style.overflow = 'auto';
        }

        function searchGiaiDau() {
            const filter = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('#giaidauContainer .card');

            cards.forEach(card => {
                const ten = card.getAttribute('data-ten');
                if (ten.includes(filter)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('videoModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        window.onload = () => {
            loadGiaiDau();
            updateAuthButtons();
            document.getElementById('searchInput').addEventListener('input', searchGiaiDau);
        };

        function updateAuthButtons() {
            const authButtons = document.getElementById('authButtons');
            const token = localStorage.getItem('adminToken');
            const user = localStorage.getItem('adminUser');

            if (token && user) {
                // Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p
                const userData = JSON.parse(user);
                authButtons.innerHTML = `
                    <div class="user-info" style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: white; font-size: 14px;">Xin ch√†o, ${userData.HoTen || userData.TenDangNhap}</span>
                        <button onclick="logout()" class="logout-btn" style="
                            background: #ff4757;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background 0.3s;
                        " onmouseover="this.style.background='#ff3742'" onmouseout="this.style.background='#ff4757'">
                            ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                `;
            } else {
                // Ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p
                authButtons.innerHTML = `
                    <a href="login.html" class="login-btn">ƒêƒÉng nh·∫≠p</a>
                    <a href="register.html" class="register-btn">ƒêƒÉng k√Ω</a>
                `;
            }
        }

        function logout() {
            // Hi·ªÉn th·ªã x√°c nh·∫≠n tr∆∞·ªõc khi ƒëƒÉng xu·∫•t
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?')) {
                // X√≥a th√¥ng tin ƒëƒÉng nh·∫≠p kh·ªèi localStorage
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                
                // Hi·ªÉn th·ªã th√¥ng b√°o
                alert('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
                
                // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
                updateAuthButtons();
                
                // C√≥ th·ªÉ chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß ho·∫∑c trang ƒëƒÉng nh·∫≠p
                // window.location.href = 'login.html';
            }
        }

        // Ki·ªÉm tra token c√≥ h·∫øt h·∫°n kh√¥ng (t√πy ch·ªçn)
        function checkTokenExpiry() {
            const token = localStorage.getItem('adminToken');
            if (token) {
                try {
                    // Decode JWT token ƒë·ªÉ ki·ªÉm tra th·ªùi gian h·∫øt h·∫°n
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const currentTime = Date.now() / 1000;
                    
                    if (payload.exp < currentTime) {
                        // Token ƒë√£ h·∫øt h·∫°n
                        localStorage.removeItem('adminToken');
                        localStorage.removeItem('adminUser');
                        updateAuthButtons();
                        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!');
                    }
                } catch (error) {
                    console.error('Error checking token expiry:', error);
                }
            }
        }

        // Ki·ªÉm tra token m·ªói 5 ph√∫t
        setInterval(checkTokenExpiry, 5 * 60 * 1000);
        
        // Ki·ªÉm tra token ngay khi trang ƒë∆∞·ª£c t·∫£i
        checkTokenExpiry();
    </script>
</body>
</html>