<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·∫≠n ƒê·∫•u - Valorant Tournament</title>
    <link rel="stylesheet" href="/CSS/trandau.css">
</head>
<body>
      <div class="header">
        <div class="logo">üéÆ VALORANT</div>
        <div class="nav">
          <a href="index.html">Trang ch·ªß</a>
          <a href="giaidau.html">Gi·∫£i ƒë·∫•u</a>
          <a href="team.html">Team</a>
          <a href="trandau.html">Tr·∫≠n ƒê·∫•u</a>
          <a href="xephang.html">B·∫£ng X·∫øp H·∫°ng</a>
          <a href="map.html">Map</a>
          <a href="admin.html">Qu·∫£n L√Ω</a>
        </div>
        <div class="auth-buttons" id="authButtons">
          <!-- S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi JavaScript -->
          <a href="login.html" class="login-btn" id="loginBtn">ƒêƒÉng nh·∫≠p</a>
          <a href="register.html" class="register-btn" id="registerBtn">ƒêƒÉng k√Ω</a>
        </div>
    </div>

    <div class="container">
        <h1 class="page-title">TR·∫¨N ƒê·∫§U</h1>
        <p class="page-subtitle">Theo d√µi l·ªãch thi ƒë·∫•u v√† k·∫øt qu·∫£ c√°c tr·∫≠n ƒë·∫•u</p>

        <div class="filters">
            <div class="filter-group">
                <label for="tournamentFilter">Gi·∫£i ƒë·∫•u:</label>
                <select id="tournamentFilter">
                    <option value="">T·∫•t c·∫£ gi·∫£i ƒë·∫•u</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Tr·∫°ng th√°i:</label>
                <select id="statusFilter">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="Ch∆∞a di·ªÖn ra">Ch∆∞a di·ªÖn ra</option>
                    <option value="ƒêang di·ªÖn ra">ƒêang di·ªÖn ra</option>
                    <option value="ƒê√£ k·∫øt th√∫c">ƒê√£ k·∫øt th√∫c</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="roundFilter">V√≤ng ƒë·∫•u:</label>
                <select id="roundFilter">
                    <option value="">T·∫•t c·∫£ v√≤ng ƒë·∫•u</option>
                </select>
            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            <div>‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>

        <div id="matchesContainer" class="matches-grid" style="display: none;"></div>

        <div id="noMatches" class="no-matches" style="display: none;">
            <div>üìÖ Kh√¥ng c√≥ tr·∫≠n ƒë·∫•u n√†o</div>
            <p>Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u n√†o ƒë∆∞·ª£c l√™n l·ªãch</p>
        </div>
    </div>

    <script>
        // API Base URL - thay ƒë·ªïi theo ƒë·ªãa ch·ªâ server c·ªßa b·∫°n
        const API_BASE_URL = 'http://localhost:5000';
        
        let allMatches = [];
        let tournaments = [];

        // DOM Elements
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const matchesContainer = document.getElementById('matchesContainer');
        const noMatches = document.getElementById('noMatches');
        const tournamentFilter = document.getElementById('tournamentFilter');
        const statusFilter = document.getElementById('statusFilter');
        const roundFilter = document.getElementById('roundFilter');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadTournaments();
            loadMatches();
            setupFilters();
        });

        // Load tournaments for filter
        async function loadTournaments() {
            try {
                const response = await fetch(`${API_BASE_URL}/GiaiDau/GetAll`);
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch gi·∫£i ƒë·∫•u');
                
                tournaments = await response.json();
                populateTournamentFilter();
            } catch (error) {
                console.error('Error loading tournaments:', error);
            }
        }

        // Load matches from API
        async function loadMatches() {
            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/TranDau/GetAll`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allMatches = await response.json();
                populateRoundFilter();
                displayMatches(allMatches);
                hideLoading();
                
            } catch (error) {
                console.error('Error loading matches:', error);
                showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu tr·∫≠n ƒë·∫•u. Vui l√≤ng th·ª≠ l·∫°i sau.');
                hideLoading();
            }
        }

        // Populate tournament filter
        function populateTournamentFilter() {
            tournamentFilter.innerHTML = '<option value="">T·∫•t c·∫£ gi·∫£i ƒë·∫•u</option>';
            tournaments.forEach(tournament => {
                const option = document.createElement('option');
                option.value = tournament.IdGiai;
                option.textContent = tournament.TenGiai;
                tournamentFilter.appendChild(option);
            });
        }

        // Populate round filter
        function populateRoundFilter() {
            const rounds = [...new Set(allMatches.map(match => match.VongDau).filter(round => round))];
            roundFilter.innerHTML = '<option value="">T·∫•t c·∫£ v√≤ng ƒë·∫•u</option>';
            rounds.forEach(round => {
                const option = document.createElement('option');
                option.value = round;
                option.textContent = round;
                roundFilter.appendChild(option);
            });
        }

        // Setup filter event listeners
        function setupFilters() {
            tournamentFilter.addEventListener('change', filterMatches);
            statusFilter.addEventListener('change', filterMatches);
            roundFilter.addEventListener('change', filterMatches);
        }

        // Filter matches based on selected criteria
        function filterMatches() {
            const tournamentId = tournamentFilter.value;
            const status = statusFilter.value;
            const round = roundFilter.value;

            let filteredMatches = allMatches.filter(match => {
                let matchesTournament = true;
                let matchesStatus = true;
                let matchesRound = true;

                if (tournamentId) {
                    matchesTournament = match.IdGiai == tournamentId;
                }

                if (status) {
                    matchesStatus = match.TrangThai === status;
                }

                if (round) {
                    matchesRound = match.VongDau === round;
                }

                return matchesTournament && matchesStatus && matchesRound;
            });

            displayMatches(filteredMatches);
        }

        // Display matches
        function displayMatches(matches) {
            if (matches.length === 0) {
                matchesContainer.style.display = 'none';
                noMatches.style.display = 'block';
                return;
            }

            matchesContainer.style.display = 'grid';
            noMatches.style.display = 'none';
            
            matchesContainer.innerHTML = matches.map(match => createMatchCard(match)).join('');
        }

        // Create match card HTML
        function createMatchCard(match) {
            const statusClass = getStatusClass(match.TrangThai);
            const matchDate = match.NgayThiDau ? new Date(match.NgayThiDau) : null;
            const formattedDate = matchDate ? formatDate(matchDate) : 'Ch∆∞a x√°c ƒë·ªãnh';
            const formattedTime = matchDate ? formatTime(matchDate) : '';

            return `
                <div class="match-card">
                    <div class="match-header">
                        <div class="match-round">${match.VongDau || 'V√≤ng ƒë·∫•u'}</div>
                        <div class="match-status ${statusClass}">${match.TrangThai || 'Ch∆∞a di·ªÖn ra'}</div>
                    </div>
                    
                    <div class="match-teams">
                        <div class="team">
                            <div class="team-logo">${getTeamInitials(match.TenTeam1)}</div>
                            <div class="team-name">${match.TenTeam1 || 'Team 1'}</div>
                            <div class="team-score">${match.TiSoTeam1 || 0}</div>
                        </div>
                        
                        <div class="vs-separator">VS</div>
                        
                        <div class="team">
                            <div class="team-logo">${getTeamInitials(match.TenTeam2)}</div>
                            <div class="team-name">${match.TenTeam2 || 'Team 2'}</div>
                            <div class="team-score">${match.TiSoTeam2 || 0}</div>
                        </div>
                    </div>
                    
                    <div class="match-info">
                        <div class="info-row">
                            <span class="info-label">Gi·∫£i ƒë·∫•u:</span>
                            <span class="info-value">${match.TenGiai || 'Ch∆∞a x√°c ƒë·ªãnh'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ng√†y thi ƒë·∫•u:</span>
                            <span class="info-value">${formattedDate}</span>
                        </div>
                        ${formattedTime ? `
                        <div class="info-row">
                            <span class="info-label">Gi·ªù thi ƒë·∫•u:</span>
                            <span class="info-value">${formattedTime}</span>
                        </div>
                        ` : ''}
                        ${match.TenTeamThang ? `
                        <div class="info-row">
                            <span class="info-label">ƒê·ªôi th·∫Øng:</span>
                            <span class="info-value">${match.TenTeamThang}</span>
                        </div>
                        ` : ''}
                        ${match.GhiChu ? `
                        <div class="info-row">
                            <span class="info-label">Ghi ch√∫:</span>
                            <span class="info-value">${match.GhiChu}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Get status CSS class
        function getStatusClass(status) {
            switch (status) {
                case 'Ch∆∞a di·ªÖn ra':
                    return 'status-scheduled';
                case 'ƒêang di·ªÖn ra':
                    return 'status-live';
                case 'ƒê√£ k·∫øt th√∫c':
                    return 'status-finished';
                default:
                    return 'status-scheduled';
            }
        }

        // Get team initials for logo
        function getTeamInitials(teamName) {
            if (!teamName) return '?';
            return teamName.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);
        }

        // Format date
        function formatDate(date) {
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Format time
        function formatTime(date) {
            return date.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Show loading indicator
        function showLoading() {
            loadingIndicator.style.display = 'block';
            matchesContainer.style.display = 'none';
            noMatches.style.display = 'none';
            errorMessage.style.display = 'none';
        }

        // Hide loading indicator
        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            matchesContainer.style.display = 'none';
            noMatches.style.display = 'none';
        }

        // Auto refresh every 30 seconds for live matches
        setInterval(() => {
            const hasLiveMatches = allMatches.some(match => match.TrangThai === 'ƒêang di·ªÖn ra');
            if (hasLiveMatches) {
                loadMatches();
            }
        }, 30000);
    </script>

    <script>
      // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p khi trang ƒë∆∞·ª£c t·∫£i
      window.addEventListener('load', function() {
          updateAuthButtons();
      });

      function updateAuthButtons() {
          const authButtons = document.getElementById('authButtons');
          const token = localStorage.getItem('adminToken');
          const user = localStorage.getItem('adminUser');

          if (token && user) {
              // Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p
              const userData = JSON.parse(user);
              authButtons.innerHTML = `
                  <div class="user-info" style="display: flex; align-items: center; gap: 10px;">
                      <span style="color: white; font-size: 14px;">Xin ch√†o, ${userData.HoTen || userData.TenDangNhap}</span>
                      <button onclick="logout()" class="logout-btn" style="
                          background: #ff4757;
                          color: white;
                          border: none;
                          padding: 8px 16px;
                          border-radius: 4px;
                          cursor: pointer;
                          font-size: 14px;
                          transition: background 0.3s;
                      " onmouseover="this.style.background='#ff3742'" onmouseout="this.style.background='#ff4757'">
                          ƒêƒÉng xu·∫•t
                      </button>
                  </div>
              `;
          } else {
              // Ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p
              authButtons.innerHTML = `
                  <a href="login.html" class="login-btn">ƒêƒÉng nh·∫≠p</a>
                  <a href="register.html" class="register-btn">ƒêƒÉng k√Ω</a>
              `;
          }
      }

      function logout() {
          // Hi·ªÉn th·ªã x√°c nh·∫≠n tr∆∞·ªõc khi ƒëƒÉng xu·∫•t
          if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?')) {
              // X√≥a th√¥ng tin ƒëƒÉng nh·∫≠p kh·ªèi localStorage
              localStorage.removeItem('adminToken');
              localStorage.removeItem('adminUser');
              
              // Hi·ªÉn th·ªã th√¥ng b√°o
              alert('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
              
              // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
              updateAuthButtons();
              
              // C√≥ th·ªÉ chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß ho·∫∑c trang ƒëƒÉng nh·∫≠p
              // window.location.href = 'login.html';
          }
      }

      // Ki·ªÉm tra token c√≥ h·∫øt h·∫°n kh√¥ng (t√πy ch·ªçn)
      function checkTokenExpiry() {
          const token = localStorage.getItem('adminToken');
          if (token) {
              try {
                  // Decode JWT token ƒë·ªÉ ki·ªÉm tra th·ªùi gian h·∫øt h·∫°n
                  const payload = JSON.parse(atob(token.split('.')[1]));
                  const currentTime = Date.now() / 1000;
                  
                  if (payload.exp < currentTime) {
                      // Token ƒë√£ h·∫øt h·∫°n
                      localStorage.removeItem('adminToken');
                      localStorage.removeItem('adminUser');
                      updateAuthButtons();
                      alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!');
                  }
              } catch (error) {
                  console.error('Error checking token expiry:', error);
              }
          }
      }

      // Ki·ªÉm tra token m·ªói 5 ph√∫t
      setInterval(checkTokenExpiry, 5 * 60 * 1000);
      
      // Ki·ªÉm tra token ngay khi trang ƒë∆∞·ª£c t·∫£i
      checkTokenExpiry();
  </script>
</body>
</html>