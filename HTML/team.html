<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·ªôi Tuy·ªÉn</title>
    <link rel="stylesheet" href="/CSS/team.css">
</head>
<body>
    <div class="header">
        <div class="logo">üéÆ VALORANT</div>
        <div class="nav">
          <a href="index.html">Trang ch·ªß</a>
          <a href="giaidau.html">Gi·∫£i ƒë·∫•u</a>
          <a href="team.html">Team</a>
          <a href="trandau.html">Tr·∫≠n ƒê·∫•u</a>
          <a href="xephang.html">B·∫£ng X·∫øp H·∫°ng</a>
          <a href="map.html">Map</a>
          <a href="admin.html">Qu·∫£n L√Ω</a>
        </div>
        <div class="auth-buttons" id="authButtons">
          <!-- S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi JavaScript -->
          <a href="login.html" class="login-btn" id="loginBtn">ƒêƒÉng nh·∫≠p</a>
          <a href="register.html" class="register-btn" id="registerBtn">ƒêƒÉng k√Ω</a>
        </div>
    </div>

    <div class="search-container">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm Team..." onkeyup="searchTeam()" />
        </div>
    </div>

    <div class="card-container" id="teamContainer">
        <!-- Teams will be loaded here -->
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000';
        let teams = [];
        let tournaments = [];
        let currentTeamId = null;

        // Load data when page loads
        window.addEventListener('load', function() {
            updateAuthButtons();
            loadTournaments();
            loadTeams();
        });

        // Load tournaments for dropdown
        async function loadTournaments() {
            try {
                const response = await fetch(`${API_BASE_URL}/GiaiDau/GetAll`);
                if (response.ok) {
                    tournaments = await response.json();
                    populateTournamentDropdown();
                }
            } catch (error) {
                console.error('Error loading tournaments:', error);
            }
        }

        function populateTournamentDropdown() {
            const select = document.getElementById('idGiai');
            select.innerHTML = '<option value="">Ch·ªçn gi·∫£i ƒë·∫•u</option>';
            
            tournaments.forEach(tournament => {
                const option = document.createElement('option');
                option.value = tournament.IdGiai;
                option.textContent = tournament.TenGiai;
                select.appendChild(option);
            });
        }

        // Load teams
        async function loadTeams() {
            try {
                const response = await fetch(`${API_BASE_URL}/Team/GetAll`);
                if (response.ok) {
                    teams = await response.json();
                    displayTeams(teams);
                } else {
                    console.error('Failed to load teams');
                }
            } catch (error) {
                console.error('Error loading teams:', error);
            }
        }

        function displayTeams(teamsToShow) {
            const container = document.getElementById('teamContainer');
            container.innerHTML = '';

            if (teamsToShow.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: white; font-size: 1.2rem;">Kh√¥ng c√≥ team n√†o</p>';
                return;
            }

            teamsToShow.forEach(team => {
                const card = createTeamCard(team);
                container.appendChild(card);
            });
        }

        function createTeamCard(team) {
            const card = document.createElement('div');
            card.className = 'card';
            card.setAttribute('data-ten', team.TenTeam.toLowerCase());

            const logoElement = team.Logo ? 
                `<img src="${team.Logo}" alt="Logo" class="team-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                 <div class="default-logo" style="display: none;">${team.TenTeam.charAt(0).toUpperCase()}</div>` :
                `<div class="default-logo">${team.TenTeam.charAt(0).toUpperCase()}</div>`;

            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <h3>${team.TenTeam}</h3>
                        ${team.TenGiai ? `<div class="tournament-badge">${team.TenGiai}</div>` : ''}
                    </div>
                    ${logoElement}
                </div>
                <div class="card-info">
                    <div class="info-item">
                        <span class="info-label">Captain</span>
                        <span class="info-value">${team.TenCaptain || 'Ch∆∞a c√≥'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value">${team.EmailLienHe || 'Ch∆∞a c√≥'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ng√†y ƒëƒÉng k√Ω</span>
                        <span class="info-value">${team.NgayDangKy ? new Date(team.NgayDangKy).toLocaleDateString('vi-VN') : 'Ch∆∞a c√≥'}</span>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-edit" onclick="editTeam(${team.IdTeam})">S·ª≠a</button>
                    <button class="btn btn-delete" onclick="deleteTeam(${team.IdTeam})">X√≥a</button>
                </div>
            `;

            return card;
        }

        function searchTeam() {
            const filter = document.getElementById('searchInput').value.toLowerCase();
            const filteredTeams = teams.filter(team => 
                team.TenTeam.toLowerCase().includes(filter) ||
                (team.TenCaptain && team.TenCaptain.toLowerCase().includes(filter)) ||
                (team.TenGiai && team.TenGiai.toLowerCase().includes(filter))
            );
            displayTeams(filteredTeams);
        }
    </script>
    <script>
        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p khi trang ƒë∆∞·ª£c t·∫£i
        window.addEventListener('load', function() {
            updateAuthButtons();
        });

        function updateAuthButtons() {
            const authButtons = document.getElementById('authButtons');
            const token = localStorage.getItem('adminToken');
            const user = localStorage.getItem('adminUser');

            if (token && user) {
                // Ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p
                const userData = JSON.parse(user);
                authButtons.innerHTML = `
                    <div class="user-info" style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: white; font-size: 14px;">Xin ch√†o, ${userData.HoTen || userData.TenDangNhap}</span>
                        <button onclick="logout()" class="logout-btn" style="
                            background: #ff4757;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background 0.3s;
                        " onmouseover="this.style.background='#ff3742'" onmouseout="this.style.background='#ff4757'">
                            ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                `;
            } else {
                // Ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p
                authButtons.innerHTML = `
                    <a href="login.html" class="login-btn">ƒêƒÉng nh·∫≠p</a>
                    <a href="register.html" class="register-btn">ƒêƒÉng k√Ω</a>
                `;
            }
        }

        
        function logout() {
            // Hi·ªÉn th·ªã x√°c nh·∫≠n tr∆∞·ªõc khi ƒëƒÉng xu·∫•t
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?')) {
                // X√≥a th√¥ng tin ƒëƒÉng nh·∫≠p kh·ªèi localStorage
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                
                // Hi·ªÉn th·ªã th√¥ng b√°o
                alert('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
                
                // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
                updateAuthButtons();
                
                // C√≥ th·ªÉ chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß ho·∫∑c trang ƒëƒÉng nh·∫≠p
                // window.location.href = 'login.html';
            }
        }

        // Ki·ªÉm tra token c√≥ h·∫øt h·∫°n kh√¥ng (t√πy ch·ªçn)
        function checkTokenExpiry() {
            const token = localStorage.getItem('adminToken');
            if (token) {
                try {
                    // Decode JWT token ƒë·ªÉ ki·ªÉm tra th·ªùi gian h·∫øt h·∫°n
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const currentTime = Date.now() / 1000;
                    
                    if (payload.exp < currentTime) {
                        // Token ƒë√£ h·∫øt h·∫°n
                        localStorage.removeItem('adminToken');
                        localStorage.removeItem('adminUser');
                        updateAuthButtons();
                        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!');
                    }
                } catch (error) {
                    console.error('Error checking token expiry:', error);
                }
            }
        }

        // Ki·ªÉm tra token m·ªói 5 ph√∫t
        setInterval(checkTokenExpiry, 5 * 60 * 1000);
        
        // Ki·ªÉm tra token ngay khi trang ƒë∆∞·ª£c t·∫£i
        checkTokenExpiry();
    </script>
</body>
</html>