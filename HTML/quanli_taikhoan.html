<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω T√†i Kho·∫£n Qu·∫£n Tr·ªã</title>
    <link rel="stylesheet" href="/CSS/quanli_taikhoan.css">
</head>
<body>
    <div class="sidebar">
        <h2>Qu·∫£n Tr·ªã</h2>
        <a href="quanlygiaidau.html">üì¶ Gi·∫£i ƒê·∫•u</a>
        <a href="quanly_Team_Player.html">üßæ Team & Player</a>
        <a href="quanli_trandau.html">üéÆ Tr·∫≠n ƒê·∫•u</a>
        <a href="quanli_xephang.html" class="active">üìä B·∫£ng X·∫øp H·∫°ng</a>
        <a href="quanli_taikhoan.html">ü™™ T√†i kho·∫£n</a>
        <a href="quanli_map.html">üó∫Ô∏è Chi Ti·∫øt Map</a>
        <a href="index.html">üè† Quay L·∫°i</a>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="header">
                <h1>ü™™ Qu·∫£n L√Ω T√†i Kho·∫£n Qu·∫£n Tr·ªã</h1>
                <p>Qu·∫£n l√Ω th√¥ng tin t√†i kho·∫£n qu·∫£n tr·ªã vi√™n h·ªá th·ªëng</p>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openAddModal()">
                    ‚ûï Th√™m Qu·∫£n Tr·ªã Vi√™n
                </button>
                <button class="btn btn-success" onclick="refreshData()">
                    üîÑ L√†m M·ªõi
                </button>
            </div>

            <div class="data-table">
                <div class="table-header">
                    <h3>üìã Danh S√°ch Qu·∫£n Tr·ªã Vi√™n</h3>
                    <input type="text" class="search-box" placeholder="üîç T√¨m ki·∫øm..." id="searchInput">
                </div>
                
                <div id="loadingDiv" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>

                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√™n ƒêƒÉng Nh·∫≠p</th>
                            <th>H·ªç T√™n</th>
                            <th>Vai Tr√≤</th>
                            <th>M√¥ T·∫£</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                    </tbody>
                </table>

                <div id="noDataDiv" class="no-data" style="display: none;">
                    <p>üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Th√™m Qu·∫£n Tr·ªã Vi√™n -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>‚ûï Th√™m Qu·∫£n Tr·ªã Vi√™n M·ªõi</h4>
                <span class="close" onclick="closeModal('addModal')">√ó</span>
            </div>
            <div id="addModalAlert"></div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="form-group">
                        <label for="addTenDangNhap">T√™n ƒêƒÉng Nh·∫≠p *</label>
                        <input type="text" class="form-control" id="addTenDangNhap" required>
                    </div>
                    <div class="form-group">
                        <label for="addMatKhau">M·∫≠t Kh·∫©u *</label>
                        <input type="password" class="form-control" id="addMatKhau" required minlength="6">
                        <small style="color: #666;">T·ªëi thi·ªÉu 6 k√Ω t·ª±</small>
                    </div>
                    <div class="form-group">
                        <label for="addHoTen">H·ªç T√™n *</label>
                        <input type="text" class="form-control" id="addHoTen" required>
                    </div>
                    <div class="form-group">
                        <label for="addVaiTro">Vai Tr√≤ *</label>
                        <select class="form-control" id="addVaiTro" required>
                            <option value="">-- Ch·ªçn vai tr√≤ --</option>
                            <option value="Admin">Admin</option>
                            <option value="Viewer">Viewer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addMoTa">M√¥ T·∫£</label>
                        <textarea class="form-control" id="addMoTa" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addModal')">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="addAdmin()">Th√™m</button>
            </div>
        </div>
    </div>

    <!-- Modal S·ª≠a Qu·∫£n Tr·ªã Vi√™n -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>‚úèÔ∏è S·ª≠a Th√¥ng Tin Qu·∫£n Tr·ªã Vi√™n</h4>
                <span class="close" onclick="closeModal('editModal')">√ó</span>
            </div>
            <div id="editModalAlert"></div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId">
                    <div class="form-group">
                        <label for="editTenDangNhap">T√™n ƒêƒÉng Nh·∫≠p</label>
                        <input type="text" class="form-control" id="editTenDangNhap" readonly style="background-color: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label for="editHoTen">H·ªç T√™n *</label>
                        <input type="text" class="form-control" id="editHoTen" required>
                    </div>
                    <div class="form-group">
                        <label for="editVaiTro">Vai Tr√≤ *</label>
                        <select class="form-control" id="editVaiTro" required>
                            <option value="Admin">Admin</option>
                            <option value="Viewer">Viewer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editMoTa">M√¥ T·∫£</label>
                        <textarea class="form-control" id="editMoTa" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">H·ªßy</button>
                <button type="button" class="btn btn-warning" onclick="updateAdmin()">C·∫≠p Nh·∫≠t</button>
            </div>
        </div>
    </div>

    <!-- Modal ƒê·ªïi M·∫≠t Kh·∫©u -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>üîë ƒê·ªïi M·∫≠t Kh·∫©u</h4>
                <span class="close" onclick="closeModal('changePasswordModal')">√ó</span>
            </div>
            <div id="changePasswordModalAlert"></div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <input type="hidden" id="changePasswordId">
                    <div class="form-group">
                        <label for="matKhauCu">M·∫≠t Kh·∫©u C≈© *</label>
                        <input type="password" class="form-control" id="matKhauCu" required>
                    </div>
                    <div class="form-group">
                        <label for="matKhauMoi">M·∫≠t Kh·∫©u M·ªõi *</label>
                        <input type="password" class="form-control" id="matKhauMoi" required minlength="6">
                        <small style="color: #666;">T·ªëi thi·ªÉu 6 k√Ω t·ª±</small>
                    </div>
                    <div class="form-group">
                        <label for="xacNhanMatKhau">X√°c Nh·∫≠n M·∫≠t Kh·∫©u M·ªõi *</label>
                        <input type="password" class="form-control" id="xacNhanMatKhau" required minlength="6">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="changePassword()">ƒê·ªïi M·∫≠t Kh·∫©u</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification" style="display: none;">
        <span id="notificationMessage"></span>
        <span class="notification-close" onclick="closeNotification()">√ó</span>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000';
        let adminData = [];

        // Notification functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            messageElement.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(closeNotification, 3000);
        }

        function closeNotification() {
            document.getElementById('notification').style.display = 'none';
        }

        // Show/hide loading
        function showLoading() {
            document.getElementById('loadingDiv').style.display = 'flex';
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('noDataDiv').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingDiv').style.display = 'none';
        }

        // Hi·ªÉn th·ªã d·ªØ li·ªáu
        function displayData(data = adminData) {
            const tableBody = document.getElementById('tableBody');
            const noDataDiv = document.getElementById('noDataDiv');
            const dataTable = document.getElementById('dataTable');

            hideLoading();
            if (data.length === 0) {
                dataTable.style.display = 'none';
                noDataDiv.style.display = 'block';
                return;
            }

            dataTable.style.display = 'table';
            noDataDiv.style.display = 'none';

            tableBody.innerHTML = '';
            data.forEach(admin => {
                const badgeClass = admin.VaiTro === 'Admin' ? 'badge-admin' : 'badge-Viewer';
                const row = `
                    <tr>
                        <td>${admin.IdQuanTri}</td>
                        <td>${admin.TenDangNhap}</td>
                        <td>${admin.HoTen}</td>
                        <td><span class="badge ${badgeClass}">${admin.VaiTro}</span></td>
                        <td>${admin.MoTa || ''}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="openEditModal(${admin.IdQuanTri})">‚úèÔ∏è S·ª≠a</button>
                            <button class="btn btn-primary btn-sm" onclick="openChangePasswordModal(${admin.IdQuanTri})">üîë ƒê·ªïi MK</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteAdmin(${admin.IdQuanTri})">üóëÔ∏è X√≥a</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // T√¨m ki·∫øm
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const filteredData = adminData.filter(admin => 
                admin.TenDangNhap.toLowerCase().includes(searchTerm) ||
                admin.HoTen.toLowerCase().includes(searchTerm) ||
                admin.VaiTro.toLowerCase().includes(searchTerm) ||
                (admin.MoTa && admin.MoTa.toLowerCase().includes(searchTerm))
            );
            displayData(filteredData);
        });

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.getElementById(`${modalId}Alert`).innerHTML = '';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
        }

        function openAddModal() {
            openModal('addModal');
        }

        async function openEditModal(id) {
            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/QuanTri/GetById/${id}`);
                const data = await response.json();
                hideLoading();
                if (response.ok) {
                    document.getElementById('editId').value = data.IdQuanTri;
                    document.getElementById('editTenDangNhap').value = data.TenDangNhap;
                    document.getElementById('editHoTen').value = data.HoTen;
                    document.getElementById('editVaiTro').value = data.VaiTro;
                    document.getElementById('editMoTa').value = data.MoTa || '';
                    openModal('editModal');
                } else {
                    showNotification(`L·ªói: ${data.error}`, 'error');
                }
            } catch (error) {
                hideLoading();
                showNotification(`L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
            }
        }

        function openChangePasswordModal(id) {
            document.getElementById('changePasswordId').value = id;
            openModal('changePasswordModal');
        }

        // CRUD Operations
        async function addAdmin() {
            const tenDangNhap = document.getElementById('addTenDangNhap').value.trim();
            const matKhau = document.getElementById('addMatKhau').value;
            const hoTen = document.getElementById('addHoTen').value.trim();
            const vaiTro = document.getElementById('addVaiTro').value;
            const moTa = document.getElementById('addMoTa').value.trim();

            if (!tenDangNhap || !matKhau || !hoTen || !vaiTro) {
                document.getElementById('addModalAlert').innerHTML = 
                    '<div class="alert alert-error">‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!</div>';
                return;
            }

            if (matKhau.length < 6) {
                document.getElementById('addModalAlert').innerHTML = 
                    '<div class="alert alert-error">‚ö†Ô∏è M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!</div>';
                return;
            }

            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/QuanTri/Register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        TenDangNhap: tenDangNhap,
                        MatKhau: matKhau,
                        HoTen: hoTen,
                        VaiTro: vaiTro,
                        MoTa: moTa
                    })
                });
                const result = await response.json();
                hideLoading();
                if (response.ok) {
                    document.getElementById('addModalAlert').innerHTML = 
                        '<div class="alert alert-success">‚úÖ ' + result.message + '</div>';
                    setTimeout(() => {
                        closeModal('addModal');
                        loadData();
                    }, 1500);
                } else {
                    document.getElementById('addModalAlert').innerHTML = 
                        '<div class="alert alert-error">‚ùå ' + result.error + '</div>';
                }
            } catch (error) {
                hideLoading();
                document.getElementById('addModalAlert').innerHTML = 
                    '<div class="alert alert-error">‚ùå L·ªói k·∫øt n·ªëi: ' + error.message + '</div>';
            }
        }

        async function updateAdmin() {
            const id = parseInt(document.getElementById('editId').value);
            const hoTen = document.getElementById('editHoTen').value.trim();
            const vaiTro = document.getElementById('editVaiTro').value;
            const moTa = document.getElementById('editMoTa').value.trim();

            if (!hoTen || !vaiTro) {
                document.getElementById('editModalAlert').innerHTML = 
                    '<div class="alert alert-error">‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!</div>';
                return;
            }

            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/QuanTri/Update/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        HoTen: hoTen,
                        VaiTro: vaiTro,
                        MoTa: moTa
                    })
                });
                const result = await response.json();
                hideLoading();
                if (response.ok) {
                    document.getElementById('editModalAlert').innerHTML = 
                        '<div class="alert alert-success">‚úÖ ' + result.message + '</div>';
                    setTimeout(() => {
                        closeModal('editModal');
                        loadData();
                    }, 1500);
                } else {
                    document.getElementById('editModalAlert').innerHTML = 
                        '<div class="alert alert-error">‚ùå ' + result.error + '</div>';
                }
            } catch (error) {
                hideLoading();
                document.getElementById('editModalAlert').innerHTML = 
                    '<div class="alert alert-error">‚ùå L·ªói k·∫øt n·ªëi: ' + error.message + '</div>';
            }
        }

        async function changePassword() {
            const id = parseInt(document.getElementById('changePasswordId').value);
            const matKhauCu = document.getElementById('matKhauCu').value;
            const matKhauMoi = document.getElementById('matKhauMoi').value;
            const xacNhanMatKhau = document.getElementById('xacNhanMatKhau').value;

            if (!matKhauCu || !matKhauMoi || !xacNhanMatKhau) {
                document.getElementById('changePasswordModalAlert').innerHTML = 
                    '<div class="alert alert-error">‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!</div>';
                return;
            }

            if (matKhauMoi.length < 6) {
                document.getElementById('changePasswordModalAlert').innerHTML = 
                    '<div class="alert alert-error">‚ö†Ô∏è M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!</div>';
                return;
            }

            if (matKhauMoi !== xacNhanMatKhau) {
                document.getElementById('changePasswordModalAlert').innerHTML = 
                    '<div class="alert alert-error">‚ö†Ô∏è M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp!</div>';
                return;
            }

            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/QuanTri/ChangePassword/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        MatKhauCu: matKhauCu,
                        MatKhauMoi: matKhauMoi
                    })
                });
                const result = await response.json();
                hideLoading();
                if (response.ok) {
                    document.getElementById('changePasswordModalAlert').innerHTML = 
                        '<div class="alert alert-success">‚úÖ ' + result.message + '</div>';
                    setTimeout(() => {
                        closeModal('changePasswordModal');
                        loadData();
                    }, 1500);
                } else {
                    document.getElementById('changePasswordModalAlert').innerHTML = 
                        '<div class="alert alert-error">‚ùå ' + result.error + '</div>';
                }
            } catch (error) {
                hideLoading();
                document.getElementById('changePasswordModalAlert').innerHTML = 
                    '<div class="alert alert-error">‚ùå L·ªói k·∫øt n·ªëi: ' + error.message + '</div>';
            }
        }

        async function deleteAdmin(id) {
            if (!confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a qu·∫£n tr·ªã vi√™n n√†y?')) {
                return;
            }

            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/QuanTri/Delete/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                hideLoading();
                if (response.ok) {
                    showNotification('‚úÖ ' + result.message, 'success');
                    loadData();
                } else {
                    showNotification('‚ùå ' + result.error, 'error');
                }
            } catch (error) {
                hideLoading();
                showNotification('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
            }
        }

        async function refreshData() {
            loadData();
        }

        async function loadData() {
            try {
                showLoading();
                const response = await fetch(`${API_BASE_URL}/QuanTri/GetAll`);
                const data = await response.json();
                hideLoading();
                if (response.ok) {
                    adminData = data;
                    displayData();
                } else {
                    showNotification(`L·ªói: ${data.error}`, 'error');
                    displayData([]);
                }
            } catch (error) {
                hideLoading();
                showNotification(`L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
                displayData([]);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = ['addModal', 'editModal', 'changePasswordModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
    </script>
</body>
</html>