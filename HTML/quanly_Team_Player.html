<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qu·∫£n l√Ω ƒë·ªôi v√† th√†nh vi√™n</title>
  <link rel="stylesheet" href="/CSS/quanly_Team_Player.css">
</head>
<body>
  <div class="sidebar">
    <h2>Qu·∫£n Tr·ªã</h2>
    <a href="quanlygiaidau.html">üì¶ Gi·∫£i ƒê·∫•u</a>
    <a href="quanly_Team_Player.html">üßæ Team & Player</a>
    <a href="quanli_trandau.html">üéÆ Tr·∫≠n ƒê·∫•u</a>
    <a href="quanli_xephang.html" class="active">üìä B·∫£ng X·∫øp H·∫°ng</a>
    <a href="quanli_taikhoan.html">ü™™ T√†i kho·∫£n</a>
    <a href="quanli_map.html">üó∫Ô∏è Chi Ti·∫øt Map</a>
    <a href="index.html">üè† Quay L·∫°i</a>
</div>

  <div class="content">
    <div class="header">
      <h2>Qu·∫£n L√Ω ƒê·ªôi v√† Th√†nh Vi√™n</h2>
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç T√¨m ki·∫øm ƒë·ªôi ho·∫∑c th√†nh vi√™n...">
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-container">
      <button class="tab-button active" onclick="switchTab('teams')">üë• Qu·∫£n L√Ω ƒê·ªôi</button>
      <button class="tab-button" onclick="switchTab('players')">üèÉ‚Äç‚ôÇÔ∏è Qu·∫£n L√Ω Th√†nh Vi√™n</button>
    </div>

    <!-- Teams Tab -->
    <div id="teams-tab" class="tab-content active">
      <div class="table-container">
        <div class="btn-container">
          <button class="btn btn-primary" onclick="openTeamModal()">‚ûï Th√™m ƒê·ªôi M·ªõi</button>
          <button class="btn btn-success" onclick="exportTeamData()">üì§ Xu·∫•t D·ªØ Li·ªáu</button>
        </div>
        
        <div id="teamsLoadingState" class="loading">
          üîÑ ƒêang t·∫£i d·ªØ li·ªáu ƒë·ªôi...
        </div>
        
        <table id="teamsTable" style="display: none;">
          <thead>
            <tr>
              <th>ID</th>
              <th>T√™n ƒê·ªôi</th>
              <th>ƒê·ªôi Tr∆∞·ªüng</th>
              <th>Email Li√™n H·ªá</th>
              <th>Gi·∫£i ƒê·∫•u</th>
              <th>Ng√†y ƒêƒÉng K√Ω</th>
              <th>H√†nh ƒê·ªông</th>
            </tr>
          </thead>
          <tbody>
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y b·∫±ng JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Players Tab -->
    <div id="players-tab" class="tab-content">
      <div class="table-container">
        <div class="btn-container">
          <button class="btn btn-primary" onclick="openPlayerModal()">‚ûï Th√™m Th√†nh Vi√™n M·ªõi</button>
          <button class="btn btn-success" onclick="exportPlayerData()">üì§ Xu·∫•t D·ªØ Li·ªáu</button>
          <select id="teamFilter" class="btn" style="background: #95a5a6; color: white;">
            <option value="">üîΩ L·ªçc theo ƒë·ªôi</option>
            <!-- Options s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </select>
        </div>
        
        <div id="playersLoadingState" class="loading">
          üîÑ ƒêang t·∫£i d·ªØ li·ªáu th√†nh vi√™n...
        </div>
        
        <table id="playersTable" style="display: none;">
          <thead>
            <tr>
              <th>ID</th>
              <th>T√™n Game</th>
              <th>ƒê·ªôi</th>
              <th>V·ªã Tr√≠</th>
              <th>Tag Line</th>
              <th>H·ªç T√™n Th·∫≠t</th>
              <th>Rank Hi·ªán T·∫°i</th>
              <th>Main Agent</th>
              <th>H√†nh ƒê·ªông</th>
            </tr>
          </thead>
          <tbody>
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y b·∫±ng JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal for Team Management -->
  <div id="teamModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="teamModalTitle">Th√™m ƒê·ªôi M·ªõi</h3>
        <span class="close" onclick="closeTeamModal()">√ó</span>
      </div>
      <div class="modal-body">
        <form id="teamForm">
          <div class="form-group">
            <label for="teamName">T√™n ƒê·ªôi *</label>
            <input type="text" id="teamName" name="teamName" required>
          </div>
          
          <div class="form-group">
            <label for="teamCaptain">ƒê·ªôi Tr∆∞·ªüng *</label>
            <input type="text" id="teamCaptain" name="teamCaptain" required>
          </div>
          
          <div class="form-group">
            <label for="teamEmail">Email Li√™n H·ªá</label>
            <input type="email" id="teamEmail" name="teamEmail">
          </div>
          
          <div class="form-group">
            <label for="teamLogo">Logo URL</label>
            <input type="url" id="teamLogo" name="teamLogo" placeholder="https://...">
          </div>
          
          <div class="form-group">
            <label for="teamGiai">Gi·∫£i ƒê·∫•u</label>
            <select id="teamGiai" name="teamGiai">
              <option value="">Ch·ªçn gi·∫£i ƒë·∫•u</option>
              <!-- Options s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
            </select>
          </div>
          
          <div class="btn-container">
            <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
            <button type="button" class="btn btn-danger" onclick="closeTeamModal()">‚ùå H·ªßy</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal for Player Management -->
  <div id="playerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="playerModalTitle">Th√™m Th√†nh Vi√™n M·ªõi</h3>
        <span class="close" onclick="closePlayerModal()">√ó</span>
      </div>
      <div class="modal-body">
        <form id="playerForm">
          <div class="form-group">
            <label for="playerName">T√™n Game *</label>
            <input type="text" id="playerName" name="playerName" required>
          </div>
          
          <div class="form-group">
            <label for="playerTeam">ƒê·ªôi *</label>
            <select id="playerTeam" name="playerTeam" required>
              <option value="">Ch·ªçn ƒë·ªôi</option>
              <!-- Options s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
            </select>
          </div>
          
          <div class="form-group">
            <label for="playerPosition">V·ªã Tr√≠</label>
            <select id="playerPosition" name="playerPosition">
              <option value="">Ch·ªçn v·ªã tr√≠</option>
              <option value="Duelist">Duelist</option>
              <option value="Controller">Controller</option>
              <option value="Initiator">Initiator</option>
              <option value="Sentinel">Sentinel</option>
              <option value="IGL">IGL</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="playerNumber">Tag Line</label>
            <input type="text" id="playerNumber" name="playerNumber" maxlength="10" placeholder="#VN1, #NA1...">
          </div>
          
          <div class="form-group">
            <label for="playerAge">H·ªç T√™n Th·∫≠t</label>
            <input type="text" id="playerAge" name="playerAge">
          </div>
          
          <div class="form-group">
            <label for="playerPhone">Rank Hi·ªán T·∫°i</label>
            <input type="text" id="playerPhone" name="playerPhone" placeholder="Iron, Bronze, Radiant...">
          </div>
          
          <div class="form-group">
            <label for="playerEmail">Main Agent</label>
            <input type="text" id="playerEmail" name="playerEmail" placeholder="Jett, Sage, Omen...">
          </div>
          
          <div class="form-group">
            <label for="playerStatus">Tr·∫°ng Th√°i</label>
            <select id="playerStatus" name="playerStatus">
              <option value="active">Ho·∫°t ƒê·ªông</option>
              <option value="injured">B·ªã Ban</option>
              <option value="suspended">B·ªã Treo Gi√≤</option>
              <option value="inactive">T·∫°m Ngh·ªâ</option>
            </select>
          </div>
          
          <div class="btn-container">
            <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
            <button type="button" class="btn btn-danger" onclick="closePlayerModal()">‚ùå H·ªßy</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>X√°c Nh·∫≠n</h3>
        <span class="close" onclick="closeConfirmModal()">√ó</span>
      </div>
      <div class="modal-body">
        <p id="confirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y?</p>
        <div class="btn-container">
          <button class="btn btn-danger" id="confirmYes">‚úì C√≥</button>
          <button class="btn btn-primary" onclick="closeConfirmModal()">‚úó Kh√¥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification">
    <span id="notificationMessage"></span>
    <span class="notification-close" onclick="closeNotification()">√ó</span>
  </div>

  <script>
    // Global variables
    let currentEditingTeamId = null;
    let currentEditingPlayerId = null;
    let teamsData = [];
    let playersData = [];
    let giaiDauData = [];
    
    // API Base URL - thay ƒë·ªïi theo server c·ªßa b·∫°n
    const API_BASE_URL = 'http://localhost:5000'; // Thay ƒë·ªïi URL n√†y theo server c·ªßa b·∫°n
    
    // Notification functions
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      const messageElement = document.getElementById('notificationMessage');
      
      messageElement.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';
      
      setTimeout(() => closeNotification(), 3000);
    }
    
    function closeNotification() {
      document.getElementById('notification').style.display = 'none';
    }
    
    // Tab switching function
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
      
      if (tabName === 'teams') {
        loadTeams();
      } else if (tabName === 'players') {
        loadPlayers();
      }
    }
    
    // API calls for teams
    async function loadTeams() {
      try {
        document.getElementById('teamsLoadingState').style.display = 'block';
        document.getElementById('teamsTable').style.display = 'none';
        
        const response = await fetch(`${API_BASE_URL}/Team/GetAll`);
        const data = await response.json();
        
        if (response.ok) {
          teamsData = data;
          displayTeams(data);
          updateTeamFilterOptions();
        } else {
          throw new Error(data.error || 'L·ªói khi t·∫£i d·ªØ li·ªáu ƒë·ªôi');
        }
      } catch (error) {
        console.error('Error loading teams:', error);
        showNotification('L·ªói khi t·∫£i d·ªØ li·ªáu ƒë·ªôi: ' + error.message, 'error');
      } finally {
        document.getElementById('teamsLoadingState').style.display = 'none';
      }
    }
    
    // API call for tournaments (GiaiDau)
    async function loadGiaiDau() {
      try {
        const response = await fetch(`${API_BASE_URL}/GiaiDau/GetAll`);
        const data = await response.json();
        
        if (response.ok) {
          giaiDauData = data;
          updateGiaiDauOptions();
        } else {
          throw new Error(data.error || 'L·ªói khi t·∫£i danh s√°ch gi·∫£i ƒë·∫•u');
        }
      } catch (error) {
        console.error('Error loading giai dau:', error);
        showNotification('L·ªói khi t·∫£i danh s√°ch gi·∫£i ƒë·∫•u: ' + error.message, 'error');
      }
    }
    
    function updateGiaiDauOptions() {
      const select = document.getElementById('teamGiai');
      select.innerHTML = '<option value="">Ch·ªçn gi·∫£i ƒë·∫•u</option>';
      
      if (giaiDauData.length === 0) {
        console.warn('Kh√¥ng c√≥ d·ªØ li·ªáu gi·∫£i ƒë·∫•u ƒë·ªÉ hi·ªÉn th·ªã');
        return;
      }
      
      giaiDauData.forEach(giai => {
        const option = document.createElement('option');
        option.value = giai.IdGiai;
        option.textContent = giai.TenGiai;
        select.appendChild(option);
      });
    }
    
    function displayTeams(teams) {
      const tbody = document.querySelector('#teamsTable tbody');
      tbody.innerHTML = '';
      
      teams.forEach(team => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${team.IdTeam}</td>
          <td>${team.TenTeam}</td>
          <td>${team.TenCaptain || 'Ch∆∞a c√≥'}</td>
          <td>${team.EmailLienHe || 'N/A'}</td>
          <td>${team.TenGiai || 'Ch∆∞a tham gia'}</td>
          <td>${team.NgayDangKy ? new Date(team.NgayDangKy).toLocaleDateString('vi-VN') : 'N/A'}</td>
          <td>
            <button class="btn btn-warning btn-sm" onclick="editTeam(${team.IdTeam})">‚úèÔ∏è S·ª≠a</button>
            <button class="btn btn-danger btn-sm" onclick="deleteTeam(${team.IdTeam})">üóëÔ∏è X√≥a</button>
          </td>
        `;
        tbody.appendChild(row);
      });
      
      document.getElementById('teamsTable').style.display = 'table';
    }
    
    // API calls for players
    async function loadPlayers() {
      try {
        document.getElementById('playersLoadingState').style.display = 'block';
        document.getElementById('playersTable').style.display = 'none';
        
        const response = await fetch(`${API_BASE_URL}/Player/GetAll`);
        const data = await response.json();
        
        if (response.ok) {
          playersData = data;
          displayPlayers(data);
        } else {
          throw new Error(data.error || 'L·ªói khi t·∫£i d·ªØ li·ªáu th√†nh vi√™n');
        }
      } catch (error) {
        console.error('Error loading players:', error);
        showNotification('L·ªói khi t·∫£i d·ªØ li·ªáu th√†nh vi√™n: ' + error.message, 'error');
      } finally {
        document.getElementById('playersLoadingState').style.display = 'none';
      }
    }
    
    function displayPlayers(players) {
      const tbody = document.querySelector('#playersTable tbody');
      tbody.innerHTML = '';
      
      players.forEach(player => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${player.IdPlayer}</td>
          <td>${player.GameName}</td>
          <td>${player.TenTeam || 'Ch∆∞a c√≥ ƒë·ªôi'}</td>
          <td>${player.ViTri || 'N/A'}</td>
          <td>${player.TagLine || 'N/A'}</td>
          <td>${player.HoTenThat || 'N/A'}</td>
          <td>${player.RankHienTai || 'N/A'}</td>
          <td>${player.MainAgent || 'N/A'}</td>
          <td>
            <button class="btn btn-warning btn-sm" onclick="editPlayer(${player.IdPlayer})">‚úèÔ∏è S·ª≠a</button>
            <button class="btn btn-danger btn-sm" onclick="deletePlayer(${player.IdPlayer})">üóëÔ∏è X√≥a</button>
          </td>
        `;
        tbody.appendChild(row);
      });
      
      document.getElementById('playersTable').style.display = 'table';
    }
    
    function updateTeamFilterOptions() {
      const select = document.getElementById('playerTeam');
      const filterSelect = document.getElementById('teamFilter');
      select.innerHTML = '<option value="">Ch·ªçn ƒë·ªôi</option>';
      filterSelect.innerHTML = '<option value="">üîΩ L·ªçc theo ƒë·ªôi</option>';
      
      teamsData.forEach(team => {
        const option = document.createElement('option');
        option.value = team.IdTeam;
        option.textContent = team.TenTeam;
        select.appendChild(option);
        
        const filterOption = document.createElement('option');
        filterOption.value = team.IdTeam;
        filterOption.textContent = team.TenTeam;
        filterSelect.appendChild(filterOption);
      });
    }
    
    // Modal functions for teams
    async function openTeamModal(teamId = null) {
      const modal = document.getElementById('teamModal');
      const title = document.getElementById('teamModalTitle');
      
      await loadGiaiDau(); // Ensure tournament data is loaded before opening modal
      
      if (teamId) {
        title.textContent = 'Ch·ªânh S·ª≠a ƒê·ªôi';
        currentEditingTeamId = teamId;
        await loadTeamData(teamId);
      } else {
        title.textContent = 'Th√™m ƒê·ªôi M·ªõi';
        currentEditingTeamId = null;
        document.getElementById('teamForm').reset();
      }
      
      modal.style.display = 'block';
    }
    
    function closeTeamModal() {
      document.getElementById('teamModal').style.display = 'none';
      currentEditingTeamId = null;
    }
    
    async function loadTeamData(teamId) {
      try {
        const response = await fetch(`${API_BASE_URL}/Team/GetById/${teamId}`);
        const team = await response.json();
        
        if (response.ok) {
          document.getElementById('teamName').value = team.TenTeam || '';
          document.getElementById('teamCaptain').value = team.TenCaptain || '';
          document.getElementById('teamEmail').value = team.EmailLienHe || '';
          document.getElementById('teamLogo').value = team.Logo || '';
          document.getElementById('teamGiai').value = team.IdGiai || '';
        } else {
          throw new Error(team.error || 'L·ªói khi t·∫£i th√¥ng tin ƒë·ªôi');
        }
      } catch (error) {
        console.error('Error loading team data:', error);
        showNotification('L·ªói khi t·∫£i th√¥ng tin ƒë·ªôi: ' + error.message, 'error');
      }
    }
    
    function editTeam(teamId) {
      openTeamModal(teamId);
    }
    
    async function deleteTeam(teamId) {
      showConfirmModal('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë·ªôi n√†y kh√¥ng?', async function() {
        try {
          const response = await fetch(`${API_BASE_URL}/Team/Delete/${teamId}`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (response.ok) {
            showNotification('X√≥a ƒë·ªôi th√†nh c√¥ng!', 'success');
            await loadTeams(); // Reload the teams list
          } else {
            throw new Error(result.error || 'L·ªói khi x√≥a ƒë·ªôi');
          }
        } catch (error) {
          console.error('Error deleting team:', error);
          showNotification('L·ªói khi x√≥a ƒë·ªôi: ' + error.message, 'error');
        }
        closeConfirmModal();
      });
    }
    
    // Modal functions for players
    async function openPlayerModal(playerId = null) {
      const modal = document.getElementById('playerModal');
      const title = document.getElementById('playerModalTitle');
      
      await loadTeams(); // Ensure team data is loaded for dropdown
      
      if (playerId) {
        title.textContent = 'Ch·ªânh S·ª≠a Th√†nh Vi√™n';
        currentEditingPlayerId = playerId;
        await loadPlayerData(playerId);
      } else {
        title.textContent = 'Th√™m Th√†nh Vi√™n M·ªõi';
        currentEditingPlayerId = null;
        document.getElementById('playerForm').reset();
        updateTeamFilterOptions(); // Update team dropdown for new player
      }
      
      modal.style.display = 'block';
    }
    
    function closePlayerModal() {
      document.getElementById('playerModal').style.display = 'none';
      currentEditingPlayerId = null;
    }
    
    async function loadPlayerData(playerId) {
      try {
        const response = await fetch(`${API_BASE_URL}/Player/GetById/${playerId}`);
        const player = await response.json();
        
        if (response.ok) {
          document.getElementById('playerName').value = player.GameName || '';
          document.getElementById('playerTeam').value = player.IdTeam || '';
          document.getElementById('playerPosition').value = player.ViTri || '';
          document.getElementById('playerNumber').value = player.TagLine || '';
          document.getElementById('playerAge').value = player.HoTenThat || '';
          document.getElementById('playerPhone').value = player.RankHienTai || '';
          document.getElementById('playerEmail').value = player.MainAgent || '';
          document.getElementById('playerStatus').value = 'active'; // Default, as schema doesn't have status
        } else {
          throw new Error(player.error || 'L·ªói khi t·∫£i th√¥ng tin th√†nh vi√™n');
        }
      } catch (error) {
        console.error('Error loading player data:', error);
        showNotification('L·ªói khi t·∫£i th√¥ng tin th√†nh vi√™n: ' + error.message, 'error');
      }
    }
    
    function editPlayer(playerId) {
      openPlayerModal(playerId);
    }
    
    async function deletePlayer(playerId) {
      showConfirmModal('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th√†nh vi√™n n√†y kh√¥ng?', async function() {
        try {
          const response = await fetch(`${API_BASE_URL}/Player/Delete/${playerId}`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          
          if (response.ok) {
            showNotification('X√≥a th√†nh vi√™n th√†nh c√¥ng!', 'success');
            await loadPlayers(); // Reload the players list
          } else {
            throw new Error(result.error || 'L·ªói khi x√≥a th√†nh vi√™n');
          }
        } catch (error) {
          console.error('Error deleting player:', error);
          showNotification('L·ªói khi x√≥a th√†nh vi√™n: ' + error.message, 'error');
        }
        closeConfirmModal();
      });
    }
    
    // Confirmation modal functions
    function showConfirmModal(message, callback) {
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmYes').onclick = callback;
      document.getElementById('confirmModal').style.display = 'block';
    }
    
    function closeConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }
    
    // Export functions
    function exportTeamData() {
      const csvContent = "data:text/csv;charset=utf-8," 
        + "ID,T√™n ƒê·ªôi,ƒê·ªôi Tr∆∞·ªüng,Email,Gi·∫£i ƒê·∫•u,Ng√†y ƒêƒÉng K√Ω\n"
        + teamsData.map(team => 
          `${team.IdTeam},"${team.TenTeam}","${team.TenCaptain || ''}","${team.EmailLienHe || ''}","${team.TenGiai || ''}","${team.NgayDangKy || ''}"`
        ).join("\n");
    
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "teams_data.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function exportPlayerData() {
      const csvContent = "data:text/csv;charset=utf-8," 
        + "ID,T√™n Game,ƒê·ªôi,V·ªã Tr√≠,Tag Line,H·ªç T√™n Th·∫≠t,Rank Hi·ªán T·∫°i,Main Agent\n"
        + playersData.map(player => 
          `${player.IdPlayer},"${player.GameName}","${player.TenTeam || ''}","${player.ViTri || ''}","${player.TagLine || ''}","${player.HoTenThat || ''}","${player.RankHienTai || ''}","${player.MainAgent || ''}"`
        ).join("\n");
    
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "players_data.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Search functionality
    function searchTeams(searchTerm) {
      const filteredTeams = teamsData.filter(team => 
        team.TenTeam.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (team.TenCaptain && team.TenCaptain.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (team.TenGiai && team.TenGiai.toLowerCase().includes(searchTerm.toLowerCase()))
      );
      displayTeams(filteredTeams);
    }
    
    function searchPlayers(searchTerm) {
      const filteredPlayers = playersData.filter(player => 
        player.GameName.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (player.TenTeam && player.TenTeam.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (player.HoTenThat && player.HoTenThat.toLowerCase().includes(searchTerm.toLowerCase()))
      );
      displayPlayers(filteredPlayers);
    }
    
    // Close modals when clicking outside
    window.onclick = function(event) {
      const teamModal = document.getElementById('teamModal');
      const playerModal = document.getElementById('playerModal');
      const confirmModal = document.getElementById('confirmModal');
      
      if (event.target === teamModal) {
        closeTeamModal();
      }
      if (event.target === playerModal) {
        closePlayerModal();
      }
      if (event.target === confirmModal) {
        closeConfirmModal();
      }
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', async function() {
      // Load initial data
      await loadTeams();
      await loadGiaiDau();
      await loadPlayers();
    
      // Initialize search functionality
      document.getElementById('searchInput').addEventListener('input', function() {
        const searchTerm = this.value.trim();
        if (searchTerm === '') {
          displayTeams(teamsData);
          displayPlayers(playersData);
        } else {
          searchTeams(searchTerm);
          searchPlayers(searchTerm);
        }
      });
    
      // Initialize team filter
      document.getElementById('teamFilter').addEventListener('change', async function() {
        const teamId = this.value;
        if (teamId) {
          try {
            const response = await fetch(`${API_BASE_URL}/Player/GetByTeam/${teamId}`);
            const data = await response.json();
            if (response.ok) {
              displayPlayers(data);
            } else {
              throw new Error(data.error || 'L·ªói khi l·ªçc th√†nh vi√™n theo ƒë·ªôi');
            }
          } catch (error) {
            console.error('Error filtering players:', error);
            showNotification('L·ªói khi l·ªçc th√†nh vi√™n: ' + error.message, 'error');
          }
        } else {
          displayPlayers(playersData);
        }
      });
    
      // Team form submission handler
      document.getElementById('teamForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
          TenTeam: document.getElementById('teamName').value,
          TenCaptain: document.getElementById('teamCaptain').value,
          EmailLienHe: document.getElementById('teamEmail').value,
          Logo: document.getElementById('teamLogo').value,
          IdGiai: document.getElementById('teamGiai').value || null
        };
    
        try {
          let response;
          if (currentEditingTeamId) {
            response = await fetch(`${API_BASE_URL}/Team/Update/${currentEditingTeamId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });
          } else {
            response = await fetch(`${API_BASE_URL}/Team/Create`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });
          }
    
          const result = await response.json();
          
          if (response.ok) {
            const action = currentEditingTeamId ? 'c·∫≠p nh·∫≠t' : 't·∫°o';
            showNotification(`${action.charAt(0).toUpperCase() + action.slice(1)} ƒë·ªôi th√†nh c√¥ng!`, 'success');
            closeTeamModal();
            await loadTeams();
          } else {
            throw new Error(result.error || `L·ªói khi ${currentEditingTeamId ? 'c·∫≠p nh·∫≠t' : 't·∫°o'} ƒë·ªôi`);
          }
        } catch (error) {
          console.error('Error saving team:', error);
          showNotification('L·ªói: ' + error.message, 'error');
        }
      });
    
      // Player form submission handler
      document.getElementById('playerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
          GameName: document.getElementById('playerName').value,
          TagLine: document.getElementById('playerNumber').value || '',
          HoTenThat: document.getElementById('playerAge').value || '',
          ViTri: document.getElementById('playerPosition').value || '',
          RankHienTai: document.getElementById('playerPhone').value || '',
          MainAgent: document.getElementById('playerEmail').value || '',
          IdTeam: document.getElementById('playerTeam').value || null
        };
    
        try {
          let response;
          if (currentEditingPlayerId) {
            response = await fetch(`${API_BASE_URL}/Player/Update/${currentEditingPlayerId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });
          } else {
            response = await fetch(`${API_BASE_URL}/Player/Create`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });
          }
    
          const result = await response.json();
          
          if (response.ok) {
            const action = currentEditingPlayerId ? 'c·∫≠p nh·∫≠t' : 't·∫°o';
            showNotification(`${action.charAt(0).toUpperCase() + action.slice(1)} th√†nh vi√™n th√†nh c√¥ng!`, 'success');
            closePlayerModal();
            await loadPlayers();
          } else {
            throw new Error(result.error || `L·ªói khi ${currentEditingPlayerId ? 'c·∫≠p nh·∫≠t' : 't·∫°o'} th√†nh vi√™n`);
          }
        } catch (error) {
          console.error('Error saving player:', error);
          showNotification('L·ªói: ' + error.message, 'error');
        }
      });
    });
  </script>
</body>
</html>