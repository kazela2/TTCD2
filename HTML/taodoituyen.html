<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o ƒê·ªôi Tuy·ªÉn</title>
    <link rel="stylesheet" href="/CSS/taodoituyen.css">
</head>
<body>
    <div class="header">
        <div class="logo">üéÆ</div>
        <div class="nav">
            <a href="index.html">Trang ch·ªß</a>
            <a href="giaidau.html">Gi·∫£i ƒë·∫•u</a>
            <div class="dropdown">
                <a href="#">ƒê·ªôi thi ƒë·∫•u ‚ñæ</a>
                <div class="dropdown-content">
                    <a href="timdoituyen.html">T√¨m ƒë·ªôi tuy·ªÉn</a>
                    <a href="taodoituyen.html">T·∫°o ƒë·ªôi tuy·ªÉn</a>
                </div>
            </div>
            <a href="trandau.html">Tr·∫≠n ƒê·∫•u</a>
            <a href="xephang.html">B·∫£ng X·∫øp H·∫°ng</a>
            <a href="lichsugiaidau.html">L·ªãch S·ª≠ ƒê·∫•u</a>
            <a href="admin.html">Qu·∫£n L√Ω</a>
        </div>
    </div>

    <div class="main-content">
        <div class="form-container">
            <div class="form-header">
                <div class="form-icon">‚ö°</div>
                <h2>T·∫°o ƒê·ªôi Tuy·ªÉn</h2>
                <p class="form-subtitle">X√¢y d·ª±ng ƒë·ªôi tuy·ªÉn esports chuy√™n nghi·ªáp c·ªßa b·∫°n</p>
            </div>

            <form id="form-tao-doi" autocomplete="off">
                <!-- Team Information -->
                <div class="section">
                    <div class="section-header">
                        <h3>
                            <span class="section-icon">üõ°Ô∏è</span>
                            Th√¥ng Tin ƒê·ªôi Tuy·ªÉn
                        </h3>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tenDoi">
                                <span class="label-icon">üèÜ</span>
                                T√™n ƒê·ªôi
                            </label>
                            <input type="text" id="tenDoi" name="tenDoi" 
                                   placeholder="Nh·∫≠p t√™n ƒë·ªôi tuy·ªÉn..." required />
                        </div>
                        
                        <div class="form-group">
                            <label for="tenHLV">
                                <span class="label-icon">üë®‚Äçüíº</span>
                                Hu·∫•n Luy·ªán Vi√™n
                            </label>
                            <input type="text" id="tenHLV" name="tenHLV" 
                                   placeholder="T√™n hu·∫•n luy·ªán vi√™n..." required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="selectGiaiDau">
                                <span class="label-icon">üéØ</span>
                                Gi·∫£i ƒê·∫•u
                            </label>
                            <div class="select-wrapper">
                                <select id="selectGiaiDau" name="selectGiaiDau" required>
                                    <option value="">Ch·ªçn gi·∫£i ƒë·∫•u...</option>
                                    <!-- JS s·∫Ω load danh s√°ch gi·∫£i ƒë·∫•u ·ªü ƒë√¢y -->
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Members Section -->
                <div class="section">
                    <div class="section-header">
                        <h3>
                            <span class="section-icon">üë•</span>
                            Th√†nh Vi√™n ƒê·ªôi Tuy·ªÉn
                        </h3>
                        <button type="button" class="add-member-btn" onclick="addMember()">
                            <span class="btn-icon">‚ûï</span>
                            Th√™m Th√†nh Vi√™n
                        </button>
                    </div>

                    <div class="members-container" id="membersContainer">
                        <div class="member-card" id="member-1">
                            <div class="member-header">
                                <span class="member-number">Th√†nh vi√™n #1</span>
                                <button type="button" class="remove-member-btn" onclick="removeMember(1)" style="display: none;">
                                    <span>‚úï</span>
                                </button>
                            </div>
                            <div class="member-form">
                                <div class="form-group">
                                    <label>
                                        <span class="label-icon">üë§</span>
                                        H·ªç T√™n
                                    </label>
                                    <input type="text" name="hoTen[]" placeholder="Nh·∫≠p h·ªç t√™n..." required />
                                </div>
                                <div class="form-group">
                                    <label>
                                        <span class="label-icon">‚öîÔ∏è</span>
                                        V·ªã Tr√≠
                                    </label>
                                    <input type="text" name="viTri[]" placeholder="VD: ADC, Support, Mid..." />
                                </div>
                                <div class="form-group">
                                    <label>
                                        <span class="label-icon">üî¢</span>
                                        S·ªë √Åo
                                    </label>
                                    <input type="number" name="soAo[]" placeholder="1-99" min="1" max="99" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn-reset" onclick="resetForm()">
                        <span class="btn-icon">üîÑ</span>
                        Reset Form
                    </button>
                    <button type="submit" class="btn-submit">
                        <span class="btn-icon">‚ú®</span>
                        T·∫°o ƒê·ªôi Tuy·ªÉn
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let memberCount = 1;

        // Load danh s√°ch gi·∫£i ƒë·∫•u v√†o select
        async function loadGiaiDau() {
            try {
                const res = await fetch('http://127.0.0.1:5000/GiaiDau/GetAll');
                const giaiDauList = await res.json();
                const select = document.getElementById('selectGiaiDau');
                
                giaiDauList.forEach(giai => {
                    const option = document.createElement('option');
                    option.value = giai.IdGiai;
                    option.textContent = giai.TenGiai;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('L·ªói load gi·∫£i ƒë·∫•u:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch gi·∫£i ƒë·∫•u. Vui l√≤ng th·ª≠ l·∫°i!');
            }
        }

        function addMember() {
            memberCount++;
            const container = document.getElementById('membersContainer');
            const memberHTML = `
                <div class="member-card" id="member-${memberCount}">
                    <div class="member-header">
                        <span class="member-number">Th√†nh vi√™n #${memberCount}</span>
                        <button type="button" class="remove-member-btn" onclick="removeMember(${memberCount})">
                            <span>‚úï</span>
                        </button>
                    </div>
                    <div class="member-form">
                        <div class="form-group">
                            <label>
                                <span class="label-icon">üë§</span>
                                H·ªç T√™n
                            </label>
                            <input type="text" name="hoTen[]" placeholder="Nh·∫≠p h·ªç t√™n..." required />
                        </div>
                        <div class="form-group">
                            <label>
                                <span class="label-icon">‚öîÔ∏è</span>
                                V·ªã Tr√≠
                            </label>
                            <input type="text" name="viTri[]" placeholder="VD: ADC, Support, Mid..." />
                        </div>
                        <div class="form-group">
                            <label>
                                <span class="label-icon">üî¢</span>
                                S·ªë √Åo
                            </label>
                            <input type="number" name="soAo[]" placeholder="1-99" min="1" max="99" />
                        </div>
                    </div>
                </div>`;
            
            container.insertAdjacentHTML('beforeend', memberHTML);
            updateRemoveButtons();
            
            // Smooth scroll to new member
            setTimeout(() => {
                document.getElementById(`member-${memberCount}`).scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }, 100);
        }

        function removeMember(id) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√†nh vi√™n n√†y?')) {
                const memberCard = document.getElementById(`member-${id}`);
                memberCard.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    memberCard.remove();
                    updateRemoveButtons();
                }, 300);
            }
        }

        function updateRemoveButtons() {
            const memberCards = document.querySelectorAll('.member-card');
            memberCards.forEach((card, index) => {
                const removeBtn = card.querySelector('.remove-member-btn');
                if (memberCards.length > 1) {
                    removeBtn.style.display = 'flex';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }

        function resetForm() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reset form? T·∫•t c·∫£ d·ªØ li·ªáu s·∫Ω b·ªã m·∫•t.')) {
                document.getElementById('form-tao-doi').reset();
                
                // Reset members to only first member
                const membersContainer = document.getElementById('membersContainer');
                membersContainer.innerHTML = `
                    <div class="member-card" id="member-1">
                        <div class="member-header">
                            <span class="member-number">Th√†nh vi√™n #1</span>
                            <button type="button" class="remove-member-btn" onclick="removeMember(1)" style="display: none;">
                                <span>‚úï</span>
                            </button>
                        </div>
                        <div class="member-form">
                            <div class="form-group">
                                <label>
                                    <span class="label-icon">üë§</span>
                                    H·ªç T√™n
                                </label>
                                <input type="text" name="hoTen[]" placeholder="Nh·∫≠p h·ªç t√™n..." required />
                            </div>
                            <div class="form-group">
                                <label>
                                    <span class="label-icon">‚öîÔ∏è</span>
                                    V·ªã Tr√≠
                                </label>
                                <input type="text" name="viTri[]" placeholder="VD: ADC, Support, Mid..." />
                            </div>
                            <div class="form-group">
                                <label>
                                    <span class="label-icon">üî¢</span>
                                    S·ªë √Åo
                                </label>
                                <input type="number" name="soAo[]" placeholder="1-99" min="1" max="99" />
                            </div>
                        </div>
                    </div>`;
                
                memberCount = 1;
                updateRemoveButtons();
            }
        }

        // X·ª≠ l√Ω submit form
        document.getElementById('form-tao-doi').addEventListener('submit', async function(e) {
            e.preventDefault();

            const tenDoi = document.getElementById('tenDoi').value.trim();
            const tenHLV = document.getElementById('tenHLV').value.trim();
            const idGiai = document.getElementById('selectGiaiDau').value;

            // Validate
            if (!tenDoi || !tenHLV || !idGiai) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
                return;
            }

            // L·∫•y th√†nh vi√™n
            const hoTens = [...document.getElementsByName('hoTen[]')].map(i => i.value.trim());
            const viTris = [...document.getElementsByName('viTri[]')].map(i => i.value.trim());
            const soAos = [...document.getElementsByName('soAo[]')].map(i => i.value.trim());

            // Validate members
            if (hoTens.some(name => !name)) {
                alert('Vui l√≤ng nh·∫≠p h·ªç t√™n cho t·∫•t c·∫£ th√†nh vi√™n!');
                return;
            }

            // Check duplicate jersey numbers
            const soAoNumbers = soAos.filter(so => so).map(Number);
            const duplicateNumbers = soAoNumbers.filter((num, index) => soAoNumbers.indexOf(num) !== index);
            if (duplicateNumbers.length > 0) {
                alert(`S·ªë √°o b·ªã tr√πng: ${duplicateNumbers.join(', ')}. Vui l√≤ng ki·ªÉm tra l·∫°i!`);
                return;
            }

            const thanhVienList = hoTens.map((hoTen, idx) => ({
                HoTen: hoTen,
                ViTri: viTris[idx] || null,
                SoAo: soAos[idx] ? Number(soAos[idx]) : null
            }));

            const data = {
                TenDoi: tenDoi,
                TenHuanLuyenVien: tenHLV,
                IdGiai: Number(idGiai),
                ThanhVien: thanhVienList
            };

            const submitBtn = document.querySelector('.btn-submit');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="btn-icon">‚è≥</span>ƒêang t·∫°o...';
            submitBtn.disabled = true;

            try {
                const res = await fetch('http://127.0.0.1:5000/DoiThiDau/AddFull', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (res.ok) {
                    alert('T·∫°o ƒë·ªôi tuy·ªÉn th√†nh c√¥ng! üéâ');
                    resetForm();
                } else {
                    alert('L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ t·∫°o ƒë·ªôi tuy·ªÉn'));
                }
            } catch (error) {
                alert('L·ªói g·ª≠i d·ªØ li·ªáu: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Initialize
        window.onload = function() {
            loadGiaiDau();
            updateRemoveButtons();
        };
    </script>
</body>
</html>