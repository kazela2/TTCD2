<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Qu·∫£n l√Ω Chi Ti·∫øt Map</title>
    <link rel="stylesheet" href="/CSS/quanli_map.css">
</head>
<body>
    <div class="sidebar">
        <h2>Qu·∫£n Tr·ªã</h2>
        <a href="quanlygiaidau.html">üì¶ Gi·∫£i ƒê·∫•u</a>
        <a href="quanly_Team_Player.html">üßæ Team & Player</a>
        <a href="quanli_trandau.html">üéÆ Tr·∫≠n ƒê·∫•u</a>
        <a href="quanli_xephang.html">üìä B·∫£ng X·∫øp H·∫°ng</a>
        <a href="quanli_taikhoan.html">ü™™ T√†i kho·∫£n</a>
        <a href="quanli_map.html" class="active">üó∫Ô∏è Chi Ti·∫øt Map</a>
        <a href="index.html">üè† Quay L·∫°i</a>
    </div>

    <div class="main-content">
        <div class="controls">
            <div class="form-row">
                <div class="form-group">
                    <label>L·ªçc Gi·∫£i ƒê·∫•u:</label>
                    <select id="filterGiai">
                        <option value="">T·∫•t c·∫£ gi·∫£i</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>L·ªçc Tr·∫≠n ƒê·∫•u:</label>
                    <select id="filterTran">
                        <option value="">T·∫•t c·∫£ tr·∫≠n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>L·ªçc Map:</label>
                    <select id="filterMap">
                        <option value="">T·∫•t c·∫£ map</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-success" onclick="openAddModal()">‚ûï Th√™m</button>
                </div>
            </div>
        </div>
        <div class="statistics" id="stats" style="display: none;">
            <h3>üìä Th·ªëng K√™ Map</h3>
            <div class="stat-grid" id="statsGrid"></div>
        </div>
        <div class="data-table">
            <div id="loading" class="loading">‚è≥ ƒêang t·∫£i...</div>
            <div id="noData" class="no-data" style="display: none;">üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu</div>
            <table id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tr·∫≠n</th>
                        <th>Map</th>
                        <th>Th·ª© T·ª±</th>
                        <th>ƒêi·ªÉm T1</th>
                        <th>ƒêi·ªÉm T2</th>
                        <th>Th·∫Øng</th>
                        <th>V√≤ng</th>
                        <th>Ng√†y</th>
                        <th>Thao T√°c</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Th√™m Chi Ti·∫øt Map</h2>
                <span class="close" onclick="closeModal()">√ó</span>
            </div>
            <div id="modalAlert"></div>
            <form id="mapForm">
                <div class="form-group">
                    <label>Gi·∫£i ƒê·∫•u: *</label>
                    <select id="idGiai" required>
                        <option value="">Ch·ªçn gi·∫£i</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tr·∫≠n ƒê·∫•u: *</label>
                    <select id="idTran" required>
                        <option value="">Ch·ªçn tr·∫≠n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Map: *</label>
                    <select id="idMap" required>
                        <option value="">Ch·ªçn map</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Th·ª© T·ª± Map: *</label>
                    <input type="number" id="thuTuMap" min="1" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ƒêi·ªÉm T1:</label>
                        <input type="number" id="scoreTeam1" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>ƒêi·ªÉm T2:</label>
                        <input type="number" id="scoreTeam2" min="0" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Team Th·∫Øng:</label>
                    <select id="teamThang">
                        <option value="">Ch∆∞a x√°c ƒë·ªãnh</option>
                    </select>
                </div>
                <div class="form-group" style="text-align: right;">
                    <button type="button" class="btn" onclick="closeModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-success">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <div id="scoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>C·∫≠p Nh·∫≠t ƒêi·ªÉm</h2>
                <span class="close" onclick="closeScoreModal()">√ó</span>
            </div>
            <div id="scoreModalAlert"></div>
            <form id="scoreForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>ƒêi·ªÉm T1:</label>
                        <input type="number" id="updateScoreTeam1" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>ƒêi·ªÉm T2:</label>
                        <input type="number" id="updateScoreTeam2" min="0" value="0">
                    </div>
                </div>
                <div class="form-group" style="text-align: right;">
                    <button type="button" class="btn" onclick="closeScoreModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-success">C·∫≠p Nh·∫≠t</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let data = [], tranDau = [], maps = [], giaiDau = [], editingId = null, scoreId = null;

        const showNotification = (msg, type = 'error', alertId = editingId ? 'modalAlert' : 'scoreModalAlert') => {
            document.getElementById(alertId).innerHTML = `<div class="alert alert-${type}">${type === 'success' ? '‚úÖ' : '‚ùå'} ${msg}</div>`;
        };

        const toggleLoading = (show) => {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('noData').style.display = show || data.length ? 'none' : 'block';
            document.getElementById('dataTable').style.display = show ? 'none' : data.length ? 'table' : 'none';
        };

        const loadData = async (url, errorMsg) => {
            try {
                toggleLoading(true);
                const res = await fetch(url);
                const result = await res.json();
                toggleLoading(false);
                if (res.ok) return result;
                showNotification(`${errorMsg}: ${result.error}`);
                return [];
            } catch (e) {
                toggleLoading(false);
                showNotification(`L·ªói k·∫øt n·ªëi: ${e.message}`);
                return [];
            }
        };

        const loadGiaiDau = async () => {
            giaiDau = await loadData(`${API_BASE}/GiaiDau/GetAll`, 'L·ªói t·∫£i gi·∫£i ƒë·∫•u');
            const html = `<option value="">${editingId ? 'Ch·ªçn gi·∫£i' : 'T·∫•t c·∫£ gi·∫£i'}</option>` + giaiDau.map(g => `<option value="${g.IdGiai}">${g.TenGiai}</option>`).join('');
            document.getElementById('filterGiai').innerHTML = document.getElementById('idGiai').innerHTML = html;
        };

        const loadTranDau = async (giaiId = '') => {
            const url = giaiId ? `${API_BASE}/TranDau/GetByGiai/${giaiId}` : `${API_BASE}/TranDau/GetAll`;
            tranDau = await loadData(url, 'L·ªói t·∫£i tr·∫≠n ƒë·∫•u');
            const html = `<option value="">${editingId ? 'Ch·ªçn tr·∫≠n' : 'T·∫•t c·∫£ tr·∫≠n'}</option>` + tranDau.map(t => `<option value="${t.IdTran}">${t.TenTeam1} vs ${t.TenTeam2} - ${t.VongDau}</option>`).join('');
            document.getElementById('filterTran').innerHTML = document.getElementById('idTran').innerHTML = html;
        };

        const loadMaps = async () => {
            maps = await loadData(`${API_BASE}/Map/GetAll`, 'L·ªói t·∫£i map');
            const html = `<option value="">${editingId ? 'Ch·ªçn map' : 'T·∫•t c·∫£ map'}</option>` + maps.map(m => `<option value="${m.IdMap}">${m.TenMap}</option>`).join('');
            document.getElementById('filterMap').innerHTML = document.getElementById('idMap').innerHTML = html;
        };

        const loadAllData = async () => {
            data = await loadData(`${API_BASE}/ChiTietMap/GetAll`, 'L·ªói t·∫£i d·ªØ li·ªáu');
            displayData(data);
        };

        const displayData = (items) => {
            toggleLoading(false);
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = items.length ? items.map(i => `
                <tr>
                    <td>${i.IdChiTiet}</td>
                    <td>${i.TenTeam1} vs ${i.TenTeam2}</td>
                    <td>${i.TenMap}</td>
                    <td>${i.ThuTuMap}</td>
                    <td>${i.ScoreTeam1}</td>
                    <td>${i.ScoreTeam2}</td>
                    <td>${i.TenTeamThang || 'Ch∆∞a x√°c ƒë·ªãnh'}</td>
                    <td>${i.VongDau || ''}</td>
                    <td>${i.NgayThiDau ? new Date(i.NgayThiDau).toLocaleDateString('vi-VN') : ''}</td>
                    <td>
                        <button class="btn btn-warning" onclick="openScoreModal(${i.IdChiTiet},${i.ScoreTeam1},${i.ScoreTeam2})">üìä</button>
                        <button class="btn" onclick="editItem(${i.IdChiTiet})">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteItem(${i.IdChiTiet})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('') : '';
        };

        const filterData = () => {
            const [giai, tran, map] = [document.getElementById('filterGiai').value, document.getElementById('filterTran').value, document.getElementById('filterMap').value];
            let filtered = data;
            if (giai) filtered = filtered.filter(i => i.IdGiai === parseInt(giai));
            if (tran) filtered = filtered.filter(i => i.IdTran === parseInt(tran));
            if (map) {
                filtered = filtered.filter(i => i.IdMap === parseInt(map));
                loadStats(map);
            } else document.getElementById('stats').style.display = 'none';
            displayData(filtered);
        };

        const loadStats = async (mapId) => {
            const stats = await loadData(`${API_BASE}/Map/GetStatistics/${mapId}`, 'L·ªói t·∫£i th·ªëng k√™');
            if (stats) {
                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-item"><div class="stat-value">${stats.TongSoTran}</div><div class="stat-label">T·ªïng tr·∫≠n</div></div>
                    <div class="stat-item"><div class="stat-value">${stats.DiemTrungBinh}</div><div class="stat-label">ƒêi·ªÉm TB</div></div>
                    <div class="stat-item"><div class="stat-value">${stats.DiemCaoNhat}</div><div class="stat-label">ƒêi·ªÉm cao</div></div>
                    <div class="stat-item"><div class="stat-value">${stats.TranCoKetQua}</div><div class="stat-label">Tr·∫≠n c√≥ k·∫øt qu·∫£</div></div>
                `;
                document.getElementById('stats').style.display = 'block';
            }
        };

        const openAddModal = async () => {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Th√™m Chi Ti·∫øt Map';
            document.getElementById('mapForm').reset();
            document.getElementById('modalAlert').innerHTML = '';
            await loadGiaiDau();
            await loadTranDau();
            await loadMaps();
            document.getElementById('modal').style.display = 'block';
        };

        const editItem = async (id) => {
            const item = await loadData(`${API_BASE}/ChiTietMap/GetById/${id}`, 'L·ªói t·∫£i chi ti·∫øt');
            if (item) {
                editingId = id;
                document.getElementById('modalTitle').textContent = 'S·ª≠a Chi Ti·∫øt Map';
                document.getElementById('idGiai').value = item.IdGiai || '';
                await loadTranDau(item.IdGiai);
                document.getElementById('idTran').value = item.IdTran;
                document.getElementById('idMap').value = item.IdMap;
                document.getElementById('thuTuMap').value = item.ThuTuMap;
                document.getElementById('scoreTeam1').value = item.ScoreTeam1;
                document.getElementById('scoreTeam2').value = item.ScoreTeam2;
                await updateTeamOptions(item.IdTran);
                document.getElementById('teamThang').value = item.TeamThang || '';
                document.getElementById('modalAlert').innerHTML = '';
                document.getElementById('modal').style.display = 'block';
            }
        };

        const openScoreModal = (id, s1, s2) => {
            scoreId = id;
            document.getElementById('updateScoreTeam1').value = s1;
            document.getElementById('updateScoreTeam2').value = s2;
            document.getElementById('scoreModalAlert').innerHTML = '';
            document.getElementById('scoreModal').style.display = 'block';
        };

        const closeModal = () => document.getElementById('modal').style.display = 'none';
        const closeScoreModal = () => document.getElementById('scoreModal').style.display = 'none';

        const updateTeamOptions = async (tranId) => {
            const teamSelect = document.getElementById('teamThang');
            teamSelect.innerHTML = '<option value="">Ch∆∞a x√°c ƒë·ªãnh</option>';
            if (tranId) {
                const tran = tranDau.find(t => t.IdTran == tranId);
                if (tran) teamSelect.innerHTML += `<option value="${tran.Team1}">${tran.TenTeam1}</option><option value="${tran.Team2}">${tran.TenTeam2}</option>`;
            }
        };

        const submitForm = async (e, formId, url, method, alertId, closeFn) => {
            e.preventDefault();
            const formData = formId === 'mapForm' ? {
                IdGiai: parseInt(document.getElementById('idGiai').value),
                IdTran: parseInt(document.getElementById('idTran').value),
                IdMap: parseInt(document.getElementById('idMap').value),
                ThuTuMap: parseInt(document.getElementById('thuTuMap').value),
                ScoreTeam1: parseInt(document.getElementById('scoreTeam1').value) || 0,
                ScoreTeam2: parseInt(document.getElementById('scoreTeam2').value) || 0,
                TeamThang: document.getElementById('teamThang').value || null
            } : {
                ScoreTeam1: parseInt(document.getElementById('updateScoreTeam1').value) || 0,
                ScoreTeam2: parseInt(document.getElementById('updateScoreTeam2').value) || 0
            };

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const result = await res.json();
                showNotification(result.message || result.error, res.ok ? 'success' : 'error', alertId);
                if (res.ok) setTimeout(() => { closeFn(); loadAllData(); }, 1500);
            } catch (e) {
                showNotification(`L·ªói k·∫øt n·ªëi: ${e.message}`, 'error', alertId);
            }
        };

        const deleteItem = async (id) => {
            if (!confirm('X√≥a chi ti·∫øt map n√†y?')) return;
            const res = await loadData(`${API_BASE}/ChiTietMap/Delete/${id}`, 'L·ªói x√≥a');
            if (res.message) {
                alert(`‚úÖ ${res.message}`);
                loadAllData();
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await loadGiaiDau();
            await loadTranDau();
            await loadMaps();
            await loadAllData();

            document.getElementById('filterGiai').addEventListener('change', (e) => { loadTranDau(e.target.value); filterData(); });
            document.getElementById('filterTran').addEventListener('change', filterData);
            document.getElementById('filterMap').addEventListener('change', filterData);
            document.getElementById('idGiai').addEventListener('change', (e) => loadTranDau(e.target.value));
            document.getElementById('idTran').addEventListener('change', (e) => updateTeamOptions(e.target.value));
            document.getElementById('mapForm').addEventListener('submit', (e) => submitForm(e, 'mapForm', editingId ? `${API_BASE}/ChiTietMap/Update/${editingId}` : `${API_BASE}/ChiTietMap/Create`, editingId ? 'PUT' : 'POST', 'modalAlert', closeModal));
            document.getElementById('scoreForm').addEventListener('submit', (e) => submitForm(e, 'scoreForm', `${API_BASE}/ChiTietMap/UpdateScore/${scoreId}`, 'PUT', 'scoreModalAlert', closeScoreModal));

            window.onclick = (e) => {
                if (e.target === document.getElementById('modal')) closeModal();
                if (e.target === document.getElementById('scoreModal')) closeScoreModal();
            };
        });
    </script>
</body>
</html>