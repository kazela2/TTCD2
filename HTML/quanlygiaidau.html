<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Qu·∫£n l√Ω gi·∫£i ƒë·∫•u</title>
    <link rel="stylesheet" href="/CSS/quanlygiaidau.css">
</head>
<body>
    <div class="sidebar">
        <h2>Qu·∫£n Tr·ªã</h2>
        <a href="quanlygiaidau.html">üì¶ Gi·∫£i ƒê·∫•u</a>
        <a href="quanly_Team_Player.html">üßæ Team & Player</a>
        <a href="quanli_trandau.html">üéÆ Tr·∫≠n ƒê·∫•u</a>
        <a href="quanli_xephang.html" class="active">üìä B·∫£ng X·∫øp H·∫°ng</a>
        <a href="quanli_taikhoan.html">ü™™ T√†i kho·∫£n</a>
        <a href="quanli_map.html">üó∫Ô∏è Chi Ti·∫øt Map</a>
        <a href="index.html">üè† Quay L·∫°i</a>
    </div>

    <div class="content">
        <div class="header">
            <h2>üèÜ Qu·∫£n L√Ω Gi·∫£i ƒê·∫•u</h2>
            <div class="btn-container">
                <button class="btn btn-primary" onclick="openAddModal()">
                    ‚ûï Th√™m Gi·∫£i ƒê·∫•u M·ªõi
                </button>
                <button class="btn btn-success" onclick="loadGiaiDau()">
                    üîÑ L√†m M·ªõi
                </button>
            </div>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç T√¨m ki·∫øm gi·∫£i ƒë·∫•u..." onkeyup="searchTournaments()">
            </div>
        </div>

        <div class="table-container">
            <div id="loadingState" class="loading">
                üîÑ ƒêang t·∫£i d·ªØ li·ªáu...
            </div>
            <table id="giaiTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>T√™n Gi·∫£i</th>
                        <th>Ng√†y B·∫Øt ƒê·∫ßu</th>
                        <th>Ng√†y K·∫øt Th√∫c</th>
                        <th>S·ªë Team</th>
                        <th>Gi·∫£i Th∆∞·ªüng</th>
                        <th>M√¥ T·∫£</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y b·∫±ng JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Th√™m/S·ª≠a Gi·∫£i ƒê·∫•u -->
    <div id="tournamentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Th√™m Gi·∫£i ƒê·∫•u M·ªõi</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="tournamentForm">
                    <div class="form-group">
                        <label for="tenGiai">T√™n Gi·∫£i ƒê·∫•u *</label>
                        <input type="text" id="tenGiai" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ngayBatDau">Ng√†y B·∫Øt ƒê·∫ßu</label>
                        <input type="date" id="ngayBatDau">
                    </div>
                    
                    <div class="form-group">
                        <label for="ngayKetThuc">Ng√†y K·∫øt Th√∫c</label>
                        <input type="date" id="ngayKetThuc">
                    </div>
                    
                    <div class="form-group">
                        <label for="soTeamThamGia">S·ªë Team Tham Gia</label>
                        <input type="number" id="soTeamThamGia" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="giaiThuong">Gi·∫£i Th∆∞·ªüng (VND)</label>
                        <input type="number" id="giaiThuong" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="hinhAnh">H√¨nh ·∫¢nh (URL)</label>
                        <input type="url" id="hinhAnh" placeholder="https://example.com/image.jpg">
                    </div>
                    
                    <div class="form-group">
                        <label for="moTa">M√¥ T·∫£</label>
                        <textarea id="moTa" placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt v·ªÅ gi·∫£i ƒë·∫•u..."></textarea>
                    </div>
                    
                    <div class="btn-container">
                        <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
                        <button type="button" class="btn btn-danger" onclick="closeModal()">‚ùå H·ªßy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentEditId = null;

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return 'Ch∆∞a x√°c ƒë·ªãnh';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        async function loadGiaiDau() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('giaiTable').style.display = 'none';
                
                const res = await fetch("http://127.0.0.1:5000/GiaiDau/GetAll");
                const data = await res.json();
                
                const tbody = document.querySelector("#giaiTable tbody");
                tbody.innerHTML = "";

                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="empty-state">
                                <div>
                                    <h3>Ch∆∞a c√≥ gi·∫£i ƒë·∫•u n√†o</h3>
                                    <p>H√£y th√™m gi·∫£i ƒë·∫•u ƒë·∫ßu ti√™n!</p>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    data.forEach(giai => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td><strong>#${giai.IdGiai}</strong></td>
                            <td><strong>${giai.TenGiai}</strong></td>
                            <td><span class="date-display">${formatDate(giai.NgayBatDau)}</span></td>
                            <td><span class="date-display">${formatDate(giai.NgayKetThuc)}</span></td>
                            <td><strong>${giai.SoTeamThamGia}</strong></td>
                            <td><span class="currency">${formatCurrency(giai.GiaiThuong)}</span></td>
                            <td>${giai.MoTa ? (giai.MoTa.length > 50 ? giai.MoTa.substring(0, 50) + '...' : giai.MoTa) : 'Kh√¥ng c√≥ m√¥ t·∫£'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-warning" onclick="editGiaiDau(${giai.IdGiai})">‚úèÔ∏è</button>
                                    <button class="btn btn-danger" onclick="xoaGiaiDau(${giai.IdGiai})">üóëÔ∏è</button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('giaiTable').style.display = 'table';
            } catch (error) {
                console.error("L·ªói khi t·∫£i gi·∫£i ƒë·∫•u:", error);
                document.getElementById('loadingState').innerHTML = '‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.';
            }
        }

        function openAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Th√™m Gi·∫£i ƒê·∫•u M·ªõi';
            document.getElementById('tournamentForm').reset();
            document.getElementById('tournamentModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        async function editGiaiDau(id) {
            try {
                const res = await fetch(`http://127.0.0.1:5000/GiaiDau/GetById/${id}`);
                const giai = await res.json();
                
                if (res.ok) {
                    currentEditId = id;
                    document.getElementById('modalTitle').textContent = 'Ch·ªânh S·ª≠a Gi·∫£i ƒê·∫•u';
                    document.getElementById('tenGiai').value = giai.TenGiai || '';
                    document.getElementById('ngayBatDau').value = giai.NgayBatDau || '';
                    document.getElementById('ngayKetThuc').value = giai.NgayKetThuc || '';
                    document.getElementById('soTeamThamGia').value = giai.SoTeamThamGia || 0;
                    document.getElementById('giaiThuong').value = giai.GiaiThuong || 0;
                    document.getElementById('hinhAnh').value = giai.HinhAnh || '';
                    document.getElementById('moTa').value = giai.MoTa || '';
                    
                    document.getElementById('tournamentModal').style.display = 'block';
                    document.body.style.overflow = 'hidden';
                } else {
                    alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin gi·∫£i ƒë·∫•u!');
                }
            } catch (error) {
                console.error('L·ªói khi l·∫•y th√¥ng tin gi·∫£i ƒë·∫•u:', error);
                alert('C√≥ l·ªói x·∫£y ra khi l·∫•y th√¥ng tin gi·∫£i ƒë·∫•u!');
            }
        }

        function closeModal() {
            document.getElementById('tournamentModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentEditId = null;
        }

        async function xoaGiaiDau(id) {
            if (confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a gi·∫£i ƒë·∫•u n√†y kh√¥ng?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) {
                try {
                    const res = await fetch(`http://127.0.0.1:5000/GiaiDau/Delete/${id}`, {
                        method: "DELETE"
                    });
                    const result = await res.json();
                    
                    if (res.ok) {
                        alert("‚úÖ " + (result.message || "X√≥a th√†nh c√¥ng!"));
                        loadGiaiDau();
                    } else {
                        alert("‚ùå " + (result.error || "C√≥ l·ªói x·∫£y ra khi x√≥a!"));
                    }
                } catch (error) {
                    console.error("L·ªói khi g·ªçi API x√≥a:", error);
                    alert("‚ùå C√≥ l·ªói x·∫£y ra khi x√≥a gi·∫£i ƒë·∫•u!");
                }
            }
        }

        function searchTournaments() {
            const filter = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#giaiTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // X·ª≠ l√Ω form submit
        document.getElementById('tournamentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                TenGiai: document.getElementById('tenGiai').value,
                NgayBatDau: document.getElementById('ngayBatDau').value || null,
                NgayKetThuc: document.getElementById('ngayKetThuc').value || null,
                SoTeamThamGia: parseInt(document.getElementById('soTeamThamGia').value) || 0,
                GiaiThuong: parseInt(document.getElementById('giaiThuong').value) || 0,
                HinhAnh: document.getElementById('hinhAnh').value || '',
                MoTa: document.getElementById('moTa').value || ''
            };

            try {
                let url, method;
                if (currentEditId) {
                    url = `http://127.0.0.1:5000/GiaiDau/Update/${currentEditId}`;
                    method = 'PUT';
                } else {
                    url = 'http://127.0.0.1:5000/GiaiDau/Create';
                    method = 'POST';
                }

                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await res.json();

                if (res.ok) {
                    alert("‚úÖ " + (result.message || "Th√†nh c√¥ng!"));
                    closeModal();
                    loadGiaiDau();
                } else {
                    alert("‚ùå " + (result.error || "C√≥ l·ªói x·∫£y ra!"));
                }
            } catch (error) {
                console.error('L·ªói khi g·ª≠i d·ªØ li·ªáu:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi l∆∞u d·ªØ li·ªáu!');
            }
        });

        // ƒê√≥ng modal khi click b√™n ngo√†i
        window.onclick = function(event) {
            const modal = document.getElementById('tournamentModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ƒê√≥ng modal b·∫±ng ph√≠m Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // T·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c t·∫£i
        window.onload = loadGiaiDau;
    </script>
</body>
</html>