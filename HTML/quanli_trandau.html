<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Tr·∫≠n ƒê·∫•u</title>
    <link rel="stylesheet" href="/CSS/quanli_trandau.css">
</head>
<body>
    <div class="sidebar">
        <h2>Qu·∫£n Tr·ªã</h2>
        <a href="quanlygiaidau.html">üì¶ Qu·∫£n l√Ω Gi·∫£i ƒê·∫•u</a>
        <a href="quanly_Team_Player.html">üßæ Qu·∫£n l√Ω Team v√† Player</a>
        <a href="quanli_trandau.html">üéÆ Qu·∫£n l√Ω Tr·∫≠n ƒê·∫•u</a>
        <a href="quanli_xephang.html">üìä Qu·∫£n L√Ω B·∫£ng X·∫øp H·∫°ng</a>
        <a href="quanli_taikhoan.html">ü™™ Qu·∫£n L√Ω T√†i kho·∫£n</a>
        <a href="quanli_map.html">üó∫Ô∏è Qu·∫£n L√Ω Chi Ti·∫øt Map</a>
        <a href="index.html">üè† Quay L·∫°i</a>
    </div>

    <div class="content">
        <div class="header">
            <h2>üéÆ Qu·∫£n L√Ω Tr·∫≠n ƒê·∫•u</h2>
            <div class="btn-container">
                <button class="btn btn-primary" onclick="openAddModal()">+ Th√™m Tr·∫≠n ƒê·∫•u</button>
                <button class="btn btn-success" onclick="exportMatchData()">üì§ Xu·∫•t D·ªØ Li·ªáu</button>
                <button class="btn btn-success" onclick="refreshData()">üîÑ T·∫£i L·∫°i</button>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="T√¨m ki·∫øm tr·∫≠n ƒë·∫•u..." id="searchInput">
            </div>
        </div>

        <div class="table-container">
            <table id="matchTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Gi·∫£i ƒê·∫•u</th>
                        <th>ƒê·ªôi 1</th>
                        <th>ƒê·ªôi 2</th>
                        <th>T·ª∑ S·ªë</th>
                        <th>Ng√†y Thi ƒê·∫•u</th>
                        <th>V√≤ng ƒê·∫•u</th>
                        <th>Tr·∫°ng Th√°i</th>
                        <th>ƒê·ªôi Th·∫Øng</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody id="matchTableBody">
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Th√™m/S·ª≠a Tr·∫≠n ƒê·∫•u -->
    <div id="matchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Th√™m Tr·∫≠n ƒê·∫•u M·ªõi</h3>
                <span class="close" onclick="closeModal()">√ó</span>
            </div>
            <div class="modal-body">
                <form id="matchForm">
                    <div class="form-group">
                        <label for="idGiai">Gi·∫£i ƒê·∫•u *</label>
                        <select id="idGiai" name="idGiai" required>
                            <option value="">Ch·ªçn gi·∫£i ƒë·∫•u</option>
                            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="team1">ƒê·ªôi 1 *</label>
                            <select id="team1" name="team1" required>
                                <option value="">Ch·ªçn ƒë·ªôi 1</option>
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="team2">ƒê·ªôi 2 *</label>
                            <select id="team2" name="team2" required>
                                <option value="">Ch·ªçn ƒë·ªôi 2</option>
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tiSoTeam1">T·ª∑ S·ªë ƒê·ªôi 1</label>
                            <input type="number" id="tiSoTeam1" name="tiSoTeam1" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="tiSoTeam2">T·ª∑ S·ªë ƒê·ªôi 2</label>
                            <input type="number" id="tiSoTeam2" name="tiSoTeam2" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ngayThiDau">Ng√†y Thi ƒê·∫•u *</label>
                            <input type="datetime-local" id="ngayThiDau" name="ngayThiDau" required>
                        </div>
                        <div class="form-group">
                            <label for="vongDau">V√≤ng ƒê·∫•u</label>
                            <input type="text" id="vongDau" name="vongDau" placeholder="VD: V√≤ng 1, T·ª© k·∫øt...">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="trangThai">Tr·∫°ng Th√°i</label>
                            <select id="trangThai" name="trangThai">
                                <option value="Ch∆∞a di·ªÖn ra">Ch∆∞a di·ªÖn ra</option>
                                <option value="ƒêang di·ªÖn ra">ƒêang di·ªÖn ra</option>
                                <option value="ƒê√£ k·∫øt th√∫c">ƒê√£ k·∫øt th√∫c</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="teamThang">ƒê·ªôi Th·∫Øng</label>
                            <select id="teamThang" name="teamThang">
                                <option value="">Ch∆∞a x√°c ƒë·ªãnh</option>
                                <!-- S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t d·ª±a tr√™n Team1 v√† Team2 -->
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="ghiChu">Ghi Ch√∫</label>
                        <textarea id="ghiChu" name="ghiChu" placeholder="Nh·∫≠p ghi ch√∫ cho tr·∫≠n ƒë·∫•u..."></textarea>
                    </div>

                    <div class="btn-container">
                        <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
                        <button type="button" class="btn btn-danger" onclick="closeModal()">‚ùå H·ªßy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>X√°c Nh·∫≠n</h3>
                <span class="close" onclick="closeConfirmModal()">√ó</span>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y?</p>
                <div class="btn-container">
                    <button class="btn btn-danger" id="confirmYes">‚úì C√≥</button>
                    <button class="btn btn-primary" onclick="closeConfirmModal()">‚úó Kh√¥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationMessage"></span>
        <span class="notification-close" onclick="closeNotification()">√ó</span>
    </div>

    <script>
        // Global variables
        let currentMatchId = null;
        let isEditMode = false;
        let matchesData = [];
        let giaiDauData = [];
        let teamsData = [];

        // API Base URL
        const API_BASE_URL = 'http://localhost:5000'; // Thay ƒë·ªïi theo server c·ªßa b·∫°n

        // Notification functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            messageElement.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => closeNotification(), 3000);
        }

        function closeNotification() {
            document.getElementById('notification').style.display = 'none';
        }

        // Load matches
        async function loadMatches() {
            try {
                const response = await fetch(`${API_BASE_URL}/TranDau/GetAll`);
                const data = await response.json();
                if (response.ok) {
                    matchesData = data;
                    displayMatches(data);
                } else {
                    throw new Error(data.error || 'L·ªói khi t·∫£i d·ªØ li·ªáu tr·∫≠n ƒë·∫•u');
                }
            } catch (error) {
                console.error('Error loading matches:', error);
                showNotification('L·ªói khi t·∫£i d·ªØ li·ªáu tr·∫≠n ƒë·∫•u: ' + error.message, 'error');
            }
        }

        function displayMatches(matches) {
            const tbody = document.getElementById('matchTableBody');
            tbody.innerHTML = '';
            matches.forEach(match => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${match.IdTran}</td>
                    <td>${match.TenGiai || 'N/A'}</td>
                    <td>${match.TenTeam1 || 'N/A'}</td>
                    <td>${match.TenTeam2 || 'N/A'}</td>
                    <td>${match.TiSoTeam1} - ${match.TiSoTeam2}</td>
                    <td>${match.NgayThiDau ? new Date(match.NgayThiDau).toLocaleString('vi-VN') : 'N/A'}</td>
                    <td>${match.VongDau || 'N/A'}</td>
                    <td>${match.TrangThai}</td>
                    <td>${match.TenTeamThang || 'Ch∆∞a x√°c ƒë·ªãnh'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editMatch(${match.IdTran})">‚úèÔ∏è S·ª≠a</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteMatch(${match.IdTran})">üóëÔ∏è X√≥a</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load tournaments and teams for dropdowns
        async function loadGiaiDau() {
            try {
                const response = await fetch(`${API_BASE_URL}/GiaiDau/GetAll`);
                const data = await response.json();
                if (response.ok) {
                    giaiDauData = data;
                    updateGiaiDauOptions();
                } else {
                    throw new Error(data.error || 'L·ªói khi t·∫£i danh s√°ch gi·∫£i ƒë·∫•u');
                }
            } catch (error) {
                console.error('Error loading giai dau:', error);
                showNotification('L·ªói khi t·∫£i danh s√°ch gi·∫£i ƒë·∫•u: ' + error.message, 'error');
            }
        }

        async function loadTeams() {
            try {
                const response = await fetch(`${API_BASE_URL}/Team/GetAll`);
                const data = await response.json();
                if (response.ok) {
                    teamsData = data;
                    updateTeamOptions(); // C·∫≠p nh·∫≠t v·ªõi IdGiai hi·ªán t·∫°i
                } else {
                    throw new Error(data.error || 'L·ªói khi t·∫£i danh s√°ch ƒë·ªôi');
                }
            } catch (error) {
                console.error('Error loading teams:', error);
                showNotification('L·ªói khi t·∫£i danh s√°ch ƒë·ªôi: ' + error.message, 'error');
            }
        }

        function updateGiaiDauOptions() {
            const select = document.getElementById('idGiai');
            select.innerHTML = '<option value="">Ch·ªçn gi·∫£i ƒë·∫•u</option>';
            giaiDauData.forEach(giai => {
                const option = document.createElement('option');
                option.value = giai.IdGiai;
                option.textContent = giai.TenGiai;
                select.appendChild(option);
            });
        }

        function updateTeamOptions(selectedGiaiId = null) {
            const team1Select = document.getElementById('team1');
            const team2Select = document.getElementById('team2');
            team1Select.innerHTML = '<option value="">Ch·ªçn ƒë·ªôi 1</option>';
            team2Select.innerHTML = '<option value="">Ch·ªçn ƒë·ªôi 2</option>';

            // L·ªçc ƒë·ªôi theo IdGiai n·∫øu c√≥
            const filteredTeams = selectedGiaiId
                ? teamsData.filter(team => team.IdGiai === parseInt(selectedGiaiId))
                : teamsData;

            filteredTeams.forEach(team => {
                const option1 = document.createElement('option');
                option1.value = team.IdTeam;
                option1.textContent = team.TenTeam;
                team1Select.appendChild(option1);
                const option2 = document.createElement('option');
                option2.value = team.IdTeam;
                option2.textContent = team.TenTeam;
                team2Select.appendChild(option2);
            });

            updateWinnerOptions();
        }

        function updateWinnerOptions() {
            const team1 = document.getElementById('team1');
            const team2 = document.getElementById('team2');
            const teamThang = document.getElementById('teamThang');
            teamThang.innerHTML = '<option value="">Ch∆∞a x√°c ƒë·ªãnh</option>';
            if (team1.value && team1.selectedOptions[0]) {
                const option1 = document.createElement('option');
                option1.value = team1.value;
                option1.textContent = team1.selectedOptions[0].textContent;
                teamThang.appendChild(option1);
            }
            if (team2.value && team2.selectedOptions[0]) {
                const option2 = document.createElement('option');
                option2.value = team2.value;
                option2.textContent = team2.selectedOptions[0].textContent;
                teamThang.appendChild(option2);
            }
        }

        // Open modal for adding match
        async function openAddModal() {
            isEditMode = false;
            currentMatchId = null;
            document.getElementById('modalTitle').textContent = 'Th√™m Tr·∫≠n ƒê·∫•u M·ªõi';
            document.getElementById('matchForm').reset();
            await loadGiaiDau();
            await loadTeams();
            updateTeamOptions(); // C·∫≠p nh·∫≠t ƒë·ªôi v·ªõi IdGiai tr·ªëng ban ƒë·∫ßu
            document.getElementById('matchModal').style.display = 'block';
        }

        // Open modal for editing match
        async function editMatch(id) {
            isEditMode = true;
            currentMatchId = id;
            document.getElementById('modalTitle').textContent = 'S·ª≠a Tr·∫≠n ƒê·∫•u';
            await loadGiaiDau();
            await loadTeams();
            try {
                const response = await fetch(`${API_BASE_URL}/TranDau/GetById/${id}`);
                const match = await response.json();
                if (response.ok) {
                    document.getElementById('idGiai').value = match.IdGiai || '';
                    updateTeamOptions(match.IdGiai); // L·ªçc ƒë·ªôi theo IdGiai c·ªßa tr·∫≠n ƒë·∫•u
                    document.getElementById('team1').value = match.Team1 || '';
                    document.getElementById('team2').value = match.Team2 || '';
                    document.getElementById('tiSoTeam1').value = match.TiSoTeam1 || 0;
                    document.getElementById('tiSoTeam2').value = match.TiSoTeam2 || 0;
                    document.getElementById('ngayThiDau').value = match.NgayThiDau ? match.NgayThiDau.replace(' ', 'T') : '';
                    document.getElementById('vongDau').value = match.VongDau || '';
                    document.getElementById('trangThai').value = match.TrangThai || 'Ch∆∞a di·ªÖn ra';
                    document.getElementById('teamThang').value = match.TeamThang || '';
                    document.getElementById('ghiChu').value = match.GhiChu || '';
                    updateWinnerOptions();
                } else {
                    throw new Error(match.error || 'L·ªói khi t·∫£i th√¥ng tin tr·∫≠n ƒë·∫•u');
                }
            } catch (error) {
                console.error('Error loading match data:', error);
                showNotification('L·ªói khi t·∫£i th√¥ng tin tr·∫≠n ƒë·∫•u: ' + error.message, 'error');
            }
            document.getElementById('matchModal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('matchModal').style.display = 'none';
            document.getElementById('matchForm').reset();
        }

        // Delete match
        function deleteMatch(id) {
            showConfirmModal('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tr·∫≠n ƒë·∫•u n√†y?', async function() {
                try {
                    const response = await fetch(`${API_BASE_URL}/TranDau/Delete/${id}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showNotification('X√≥a tr·∫≠n ƒë·∫•u th√†nh c√¥ng!', 'success');
                        await loadMatches();
                    } else {
                        throw new Error(result.error || 'L·ªói khi x√≥a tr·∫≠n ƒë·∫•u');
                    }
                } catch (error) {
                    console.error('Error deleting match:', error);
                    showNotification('L·ªói khi x√≥a tr·∫≠n ƒë·∫•u: ' + error.message, 'error');
                }
                closeConfirmModal();
            });
        }

        // Confirmation modal functions
        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmYes').onclick = callback;
            document.getElementById('confirmModal').style.display = 'block';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // Refresh data
        function refreshData() {
            loadMatches();
        }

        // Export data
        function exportMatchData() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "ID,Gi·∫£i ƒê·∫•u,ƒê·ªôi 1,ƒê·ªôi 2,T·ª∑ S·ªë,Ng√†y Thi ƒê·∫•u,V√≤ng ƒê·∫•u,Tr·∫°ng Th√°i,ƒê·ªôi Th·∫Øng,Ghi Ch√∫\n"
                + matchesData.map(match => 
                    `${match.IdTran},"${match.TenGiai || ''}","${match.TenTeam1 || ''}","${match.TenTeam2 || ''}",`
                    + `"${match.TiSoTeam1} - ${match.TiSoTeam2}","${match.NgayThiDau || ''}",`
                    + `"${match.VongDau || ''}","${match.TrangThai}","${match.TenTeamThang || ''}","${match.GhiChu || ''}"`
                ).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "matches_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Search functionality
        function searchMatches(searchTerm) {
            const filteredMatches = matchesData.filter(match => 
                (match.TenGiai && match.TenGiai.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (match.TenTeam1 && match.TenTeam1.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (match.TenTeam2 && match.TenTeam2.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (match.VongDau && match.VongDau.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            displayMatches(filteredMatches);
        }

        // Form submission
        document.getElementById('matchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = {
                IdGiai: document.getElementById('idGiai').value,
                Team1: document.getElementById('team1').value,
                Team2: document.getElementById('team2').value,
                TiSoTeam1: parseInt(document.getElementById('tiSoTeam1').value) || 0,
                TiSoTeam2: parseInt(document.getElementById('tiSoTeam2').value) || 0,
                NgayThiDau: document.getElementById('ngayThiDau').value.replace('T', ' '),
                VongDau: document.getElementById('vongDau').value || '',
                TrangThai: document.getElementById('trangThai').value,
                TeamThang: document.getElementById('teamThang').value || null,
                GhiChu: document.getElementById('ghiChu').value || ''
            };

            // Validate team1 and team2
            if (formData.Team1 === formData.Team2) {
                showNotification('Hai ƒë·ªôi thi ƒë·∫•u kh√¥ng th·ªÉ gi·ªëng nhau', 'error');
                return;
            }

            try {
                let response;
                if (isEditMode) {
                    response = await fetch(`${API_BASE_URL}/TranDau/Update/${currentMatchId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch(`${API_BASE_URL}/TranDau/Create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }
                const result = await response.json();
                if (response.ok) {
                    const action = isEditMode ? 'c·∫≠p nh·∫≠t' : 't·∫°o';
                    showNotification(`${action.charAt(0).toUpperCase() + action.slice(1)} tr·∫≠n ƒë·∫•u th√†nh c√¥ng!`, 'success');
                    closeModal();
                    await loadMatches();
                } else {
                    throw new Error(result.error || `L·ªói khi ${isEditMode ? 'c·∫≠p nh·∫≠t' : 't·∫°o'} tr·∫≠n ƒë·∫•u`);
                }
            } catch (error) {
                console.error('Error saving match:', error);
                showNotification('L·ªói: ' + error.message, 'error');
            }
        });

        // Update winner based on score
        document.getElementById('tiSoTeam1').addEventListener('change', updateWinnerFromScore);
        document.getElementById('tiSoTeam2').addEventListener('change', updateWinnerFromScore);

        function updateWinnerFromScore() {
            const tiSoTeam1 = parseInt(document.getElementById('tiSoTeam1').value) || 0;
            const tiSoTeam2 = parseInt(document.getElementById('tiSoTeam2').value) || 0;
            const team1 = document.getElementById('team1').value;
            const team2 = document.getElementById('team2').value;
            const teamThang = document.getElementById('teamThang');
            if (tiSoTeam1 > tiSoTeam2 && team1) {
                teamThang.value = team1;
            } else if (tiSoTeam2 > tiSoTeam1 && team2) {
                teamThang.value = team2;
            } else {
                teamThang.value = '';
            }
        }

        // Team selection validation
        document.getElementById('team1').addEventListener('change', () => {
            updateWinnerOptions();
            validateTeams();
        });
        document.getElementById('team2').addEventListener('change', () => {
            updateWinnerOptions();
            validateTeams();
        });

        // Update team options when tournament changes
        document.getElementById('idGiai').addEventListener('change', function() {
            const selectedGiaiId = this.value;
            updateTeamOptions(selectedGiaiId);
        });

        function validateTeams() {
            const team1 = document.getElementById('team1').value;
            const team2 = document.getElementById('team2').value;
            if (team1 && team2 && team1 === team2) {
                showNotification('Hai ƒë·ªôi thi ƒë·∫•u kh√¥ng th·ªÉ gi·ªëng nhau', 'error');
                document.getElementById('team2').value = '';
                updateWinnerOptions();
            }
        }

        // Search
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.trim();
            if (searchTerm === '') {
                displayMatches(matchesData);
            } else {
                searchMatches(searchTerm);
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('matchModal');
            const confirmModal = document.getElementById('confirmModal');
            if (event.target === modal) {
                closeModal();
            }
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await loadMatches();
            await loadGiaiDau();
            await loadTeams();
        });
    </script>
</body>
</html>