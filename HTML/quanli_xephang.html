<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Qu·∫£n l√Ω B·∫£ng X·∫øp H·∫°ng</title>
    <link rel="stylesheet" href="/CSS/quanli_xephang.css" />
</head>
<body>
    <div class="sidebar">
        <h2>Qu·∫£n Tr·ªã</h2>
        <a href="quanlygiaidau.html">üì¶ Qu·∫£n l√Ω Gi·∫£i ƒê·∫•u</a>
        <a href="quanly_Team_Player.html">üßæ Qu·∫£n l√Ω Team v√† Player</a>
        <a href="quanli_trandau.html">üéÆ Qu·∫£n l√Ω Tr·∫≠n ƒê·∫•u</a>
        <a href="quanli_xephang.html">üìä Qu·∫£n L√Ω B·∫£ng X·∫øp H·∫°ng</a>
        <a href="quanli_taikhoan.html">ü™™ Qu·∫£n L√Ω T√†i kho·∫£n</a>
        <a href="quanli_map.html">üó∫Ô∏è Qu·∫£n L√Ω Chi Ti·∫øt Map</a>
        <a href="index.html">üè† Quay L·∫°i</a>
    </div>

    <div class="content">
        <div class="header">
            <h2>Qu·∫£n L√Ω B·∫£ng X·∫øp H·∫°ng</h2>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç T√¨m ki·∫øm ƒë·ªôi ho·∫∑c gi·∫£i ƒë·∫•u...">
            </div>
        </div>

        <div class="table-container">
            <div class="btn-container">
                <select id="tournamentFilter" class="btn" style="background: #95a5a6; color: white;">
                    <option value="">üîΩ L·ªçc theo gi·∫£i ƒë·∫•u</option>
                    <!-- Options s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                </select>
                <button class="btn btn-success" onclick="exportRankingData()">üì§ Xu·∫•t D·ªØ Li·ªáu</button>
            </div>

            <div id="rankingsLoadingState" class="loading">
                üîÑ ƒêang t·∫£i d·ªØ li·ªáu b·∫£ng x·∫øp h·∫°ng...
            </div>

            <table id="rankingsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>H·∫°ng</th>
                        <th>T√™n ƒê·ªôi</th>
                        <th>Gi·∫£i ƒê·∫•u</th>
                        <th>Tr·∫≠n ƒê√£ ƒê·∫•u</th>
                        <th>Tr·∫≠n Th·∫Øng</th>
                        <th>Tr·∫≠n Thua</th>
                        <th>T·ª∑ L·ªá Map</th>
                        <th>ƒêi·ªÉm</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y b·∫±ng JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Ranking Management -->
    <div id="rankingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="rankingModalTitle">Ch·ªânh S·ª≠a B·∫£ng X·∫øp H·∫°ng</h3>
                <span class="close" onclick="closeRankingModal()">√ó</span>
            </div>
            <div class="modal-body">
                <form id="rankingForm">
                    <div class="form-group">
                        <label for="tournamentSelect">Gi·∫£i ƒê·∫•u *</label>
                        <select id="tournamentSelect" name="tournamentSelect" required>
                            <option value="">Ch·ªçn gi·∫£i ƒë·∫•u</option>
                            <!-- Options s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="teamSelect">ƒê·ªôi *</label>
                        <select id="teamSelect" name="teamSelect" required>
                            <option value="">Ch·ªçn ƒë·ªôi</option>
                            <!-- Options s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="matchesPlayed">Tr·∫≠n ƒê√£ ƒê·∫•u</label>
                        <input type="number" id="matchesPlayed" name="matchesPlayed" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="matchesWon">Tr·∫≠n Th·∫Øng</label>
                        <input type="number" id="matchesWon" name="matchesWon" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="matchesLost">Tr·∫≠n Thua</label>
                        <input type="number" id="matchesLost" name="matchesLost" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="mapsWon">Map Th·∫Øng</label>
                        <input type="number" id="mapsWon" name="mapsWon" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="mapsLost">Map Thua</label>
                        <input type="number" id="mapsLost" name="mapsLost" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="points">ƒêi·ªÉm</label>
                        <input type="number" id="points" name="points" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="currentRank">H·∫°ng Hi·ªán T·∫°i</label>
                        <input type="number" id="currentRank" name="currentRank" min="1" required>
                    </div>

                    <div class="btn-container">
                        <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
                        <button type="button" class="btn btn-danger" onclick="closeRankingModal()">‚ùå H·ªßy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>X√°c Nh·∫≠n</h3>
                <span class="close" onclick="closeConfirmModal()">√ó</span>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y?</p>
                <div class="btn-container">
                    <button class="btn btn-danger" id="confirmYes">‚úì C√≥</button>
                    <button class="btn btn-primary" onclick="closeConfirmModal()">‚úó Kh√¥ng</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentEditingRankingId = null;
        let rankingsData = [];

        // Modal functions for rankings
        function openRankingModal(rankingId = null) {
            const modal = document.getElementById('rankingModal');
            const title = document.getElementById('rankingModalTitle');

            if (rankingId) {
                title.textContent = 'Ch·ªânh S·ª≠a B·∫£ng X·∫øp H·∫°ng';
                currentEditingRankingId = rankingId;
                loadRankingData(rankingId);
            } else {
                title.textContent = 'Th√™m B·∫£ng X·∫øp H·∫°ng M·ªõi';
                currentEditingRankingId = null;
                document.getElementById('rankingForm').reset();
            }

            modal.style.display = 'block';
        }

        function closeRankingModal() {
            document.getElementById('rankingModal').style.display = 'none';
            currentEditingRankingId = null;
        }

        // Confirmation modal functions
        function showConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmYes').onclick = callback;
            document.getElementById('confirmModal').style.display = 'block';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // Delete function
        function deleteRanking(rankingId) {
            showConfirmModal('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·ª•c b·∫£ng x·∫øp h·∫°ng n√†y kh√¥ng?', function() {
                fetch(`/BangXepHang/Delete/${rankingId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        loadRankings();
                        closeConfirmModal();
                    } else {
                        alert('X√≥a th·∫•t b·∫°i!');
                    }
                })
                .catch(error => console.error('Error deleting ranking:', error));
            });
        }

        // Load rankings data
        function loadRankings(tournamentId = '') {
            const url = tournamentId ? `/BangXepHang/GetByGiai/${tournamentId}` : '/BangXepHang/GetAll';
            document.getElementById('rankingsLoadingState').style.display = 'block';
            document.getElementById('rankingsTable').style.display = 'none';

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    rankingsData = data;
                    renderRankingsTable();
                    document.getElementById('rankingsLoadingState').style.display = 'none';
                    document.getElementById('rankingsTable').style.display = 'table';
                })
                .catch(error => {
                    console.error('Error loading rankings:', error);
                    document.getElementById('rankingsLoadingState').textContent = '‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu';
                });
        }

        // Render rankings table
        function renderRankingsTable() {
            const tbody = document.querySelector('#rankingsTable tbody');
            tbody.innerHTML = '';

            rankingsData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.HangHienTai}</td>
                    <td>${row.TenTeam}</td>
                    <td>${row.TenGiai}</td>
                    <td>${row.TranDa}</td>
                    <td>${row.TranThang}</td>
                    <td>${row.TranThua}</td>
                    <td>${row.TiLe}</td>
                    <td>${row.Diem}</td>
                    <td>
                        <button class="btn btn-primary" onclick="openRankingModal(${row.IdXH})">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteRanking(${row.IdXH})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Load ranking data for editing
        function loadRankingData(rankingId) {
            fetch(`/BangXepHang/GetById/${rankingId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('tournamentSelect').value = data.IdGiai || '';
                    document.getElementById('teamSelect').value = data.IdTeam || '';
                    document.getElementById('matchesPlayed').value = data.TranDa || 0;
                    document.getElementById('matchesWon').value = data.TranThang || 0;
                    document.getElementById('matchesLost').value = data.TranThua || 0;
                    document.getElementById('mapsWon').value = data.MapThang || 0;
                    document.getElementById('mapsLost').value = data.MapThua || 0;
                    document.getElementById('points').value = data.Diem || 0;
                    document.getElementById('currentRank').value = data.HangHienTai || 0;
                })
                .catch(error => console.error('Error loading ranking data:', error));
        }

        // Load tournaments for filter and modal
        function loadTournaments() {
            fetch('/GiaiDau/GetAll') // Gi·∫£ ƒë·ªãnh c√≥ API n√†y
                .then(response => response.json())
                .then(data => {
                    const tournamentSelect = document.getElementById('tournamentSelect');
                    const tournamentFilter = document.getElementById('tournamentFilter');
                    tournamentSelect.innerHTML = '<option value="">Ch·ªçn gi·∫£i ƒë·∫•u</option>';
                    tournamentFilter.innerHTML = '<option value="">üîΩ L·ªçc theo gi·∫£i ƒë·∫•u</option>';

                    data.forEach(tournament => {
                        const option1 = document.createElement('option');
                        option1.value = tournament.IdGiai;
                        option1.textContent = tournament.TenGiai;
                        tournamentSelect.appendChild(option1);

                        const option2 = document.createElement('option');
                        option2.value = tournament.IdGiai;
                        option2.textContent = tournament.TenGiai;
                        tournamentFilter.appendChild(option2);
                    });
                })
                .catch(error => console.error('Error loading tournaments:', error));
        }

        // Load teams for modal
        function loadTeams() {
            fetch('/Team/GetAll') // Gi·∫£ ƒë·ªãnh c√≥ API n√†y
                .then(response => response.json())
                .then(data => {
                    const teamSelect = document.getElementById('teamSelect');
                    teamSelect.innerHTML = '<option value="">Ch·ªçn ƒë·ªôi</option>';

                    data.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.IdTeam;
                        option.textContent = team.TenTeam;
                        teamSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading teams:', error));
        }

        // Export function
        function exportRankingData() {
            console.log('Exporting ranking data...');
            // Implement export logic here
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const rankingModal = document.getElementById('rankingModal');
            const confirmModal = document.getElementById('confirmModal');

            if (event.target === rankingModal) {
                closeRankingModal();
            }
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadRankings();
            loadTournaments();
            loadTeams();

            // Initialize search functionality
            document.getElementById('searchInput').addEventListener('input', function() {
                const searchValue = this.value.toLowerCase();
                const filteredData = rankingsData.filter(row =>
                    row.TenTeam.toLowerCase().includes(searchValue) ||
                    row.TenGiai.toLowerCase().includes(searchValue)
                );
                rankingsData = filteredData;
                renderRankingsTable();
            });

            // Initialize tournament filter
            document.getElementById('tournamentFilter').addEventListener('change', function() {
                loadRankings(this.value);
            });

            // Form submission handler
            document.getElementById('rankingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = {
                    IdGiai: document.getElementById('tournamentSelect').value,
                    IdTeam: document.getElementById('teamSelect').value,
                    TranDa: document.getElementById('matchesPlayed').value,
                    TranThang: document.getElementById('matchesWon').value,
                    TranThua: document.getElementById('matchesLost').value,
                    MapThang: document.getElementById('mapsWon').value,
                    MapThua: document.getElementById('mapsLost').value,
                    Diem: document.getElementById('points').value,
                    HangHienTai: document.getElementById('currentRank').value
                };

                const url = currentEditingRankingId ? `/BangXepHang/Update/${currentEditingRankingId}` : '/BangXepHang/Create';
                const method = currentEditingRankingId ? 'PUT' : 'POST';

                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (response.ok) {
                        loadRankings();
                        closeRankingModal();
                    } else {
                        alert('L∆∞u th·∫•t b·∫°i!');
                    }
                })
                .catch(error => console.error('Error saving ranking:', error));
            });
        });
    </script>
</body>
</html>